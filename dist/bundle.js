"use strict";(()=>{var $t,Ur={};function Wr(e,t){$t=e,Object.assign(Ur,t)}function A(e){$t.innerHTML="";let t=Ur[e];t&&t($t)}var Fe=[{title:"\u041C\u0438\u0442\u0442\u0435\u043B\u044C\u0448\u043F\u0438\u043B\u044C",categories:[{name:"\u0411\u043E\u0440\u044C\u0431\u0430 \u0437\u0430 \u0446\u0435\u043D\u0442\u0440",questions:[{value:100,question:"\u041A\u0430\u043A\u043E\u0439 \u043A\u043E\u043D\u044C \u0430\u043A\u0442\u0438\u0432\u043D\u0435\u0435 \u0438 \u0441\u043A\u043E\u043B\u044C\u043A\u043E \u0443 \u043D\u0435\u0433\u043E \u0445\u043E\u0434\u043E\u0432?",answer:"\u0427\u0435\u0440\u043D\u044B\u0439 \u043A\u043E\u043D\u044C. \u0423 \u043D\u0435\u0433\u043E 8 \u0445\u043E\u0434\u043E\u0432.",fen:"8/8/8/3n4/8/8/8/6N1 w - - 0 1"},{value:200,question:"\u041A\u0430\u043A\u043E\u0439 \u043A\u043E\u043D\u044C \u0430\u043A\u0442\u0438\u0432\u043D\u0435\u0435 \u0438 \u043F\u043E\u0447\u0435\u043C\u0443?",answer:"\u0411\u0435\u043B\u044B\u0439 \u043A\u043E\u043D\u044C, \u043E\u043D \u0441\u0442\u043E\u0438\u0442 \u0431\u043B\u0438\u0436\u0435 \u043A \u0446\u0435\u043D\u0442\u0440\u0443.",fen:"1k6/ppp5/n7/8/8/5N2/5PPP/6K1 w - - 0 1"},{value:300,question:"\u041A\u0442\u043E \u0432\u043B\u0430\u0434\u0435\u0435\u0442 \u0446\u0435\u043D\u0442\u0440\u043E\u043C?",answer:"\u0411\u0435\u043B\u044B\u0435, \u0438\u0445 \u043F\u0435\u0448\u043A\u0438 \u0437\u0430\u043D\u044F\u043B\u0438 \u0446\u0435\u043D\u0442\u0440.",fen:"rnbqkbnr/ppp2ppp/3pp3/8/3PP3/8/PPP2PPP/RNBQKBNR w KQkq - 0 3"},{value:400,question:"\u0423\u0441\u0438\u043B\u044C \u0441\u0432\u043E\u0435\u0433\u043E \u0431\u0435\u043B\u043E\u0433\u043E \u043A\u043E\u043D\u044F, \u043F\u0435\u0440\u0435\u0432\u0435\u0434\u044F \u0435\u0433\u043E \u0432 \u0446\u0435\u043D\u0442\u0440",answer:"\u041Af1-e3-d5",fen:"6k1/p5pp/np3p2/2p1p3/2P1P3/1P3P2/P5PP/1K3N2 w - - 0 1"},{value:500,question:"\u0423\u0441\u0438\u043B\u044C \u0441\u0432\u043E\u0435\u0433\u043E \u0431\u0435\u043B\u043E\u0433\u043E \u0441\u043B\u043E\u043D\u0430, \u043F\u0435\u0440\u0435\u0432\u0435\u0434\u044F \u0435\u0433\u043E \u0432 \u0446\u0435\u043D\u0442\u0440",answer:"\u0421a3-c1-f4-e5",fen:"2k5/ppp4p/4p1p1/3p1n2/3P3P/BPP3P1/P5K1/8 w - - 0 1"}]},{name:"\u041E\u0442\u043A\u0440\u044B\u0442\u044B\u0435 \u043B\u0438\u043D\u0438\u0438",questions:[{value:100,question:"\u041D\u0430\u0439\u0434\u0438 \u043E\u0442\u043A\u0440\u044B\u0442\u0443\u044E \u043B\u0438\u043D\u0438\u044E",answer:"\u041B\u0438\u043D\u0438\u044F b",fen:"2kr4/2p3p1/3p1p1p/p2p4/8/3P1P1P/P1PKP1P1/7R w - - 0 1"},{value:200,question:"\u041A\u0442\u043E \u0432\u043B\u0430\u0434\u0435\u0435\u0442 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u0439 \u043B\u0438\u043D\u0438\u0435\u0439?",answer:"\u0427\u0435\u0440\u043D\u044B\u0435, \u043B\u0438\u043D\u0438\u044F F.",fen:"5rk1/5rpp/p3p3/3pP3/2pP4/2P5/P5PP/R2R2K1 w - - 0 1"},{value:300,question:"\u0415\u0441\u0442\u044C \u043B\u0438 \u0437\u0434\u0435\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u0430\u044F \u043B\u0438\u043D\u0438\u044F?",answer:"\u0414\u0430, \u043B\u0438\u043D\u0438\u044F d.",fen:"4r1k1/pp3p1p/2p1p1p1/4P3/3B1P2/P1P3P1/1P4KP/8 w - - 0 1"},{value:400,question:"\u0413\u0434\u0435 \u0441\u043A\u043E\u0440\u043E \u043F\u043E\u044F\u0432\u0438\u0442\u0441\u044F \u043E\u0442\u043A\u0440\u044B\u0442\u0430\u044F \u043B\u0438\u043D\u0438\u044F? \u041A\u0430\u043A \u0431\u0435\u043B\u044B\u043C \u043F\u043E\u0434\u0433\u043E\u0442\u043E\u0432\u0438\u0442\u044C\u0441\u044F \u043A \u044D\u0442\u043E\u043C\u0443?",answer:"\u0424h1!",fen:"1kq4r/p6r/Pp3p1p/1Pp1pPp1/2PpP1PP/3P3R/1K5R/3Q4 w - - 0 1"},{value:500,question:"\u0413\u0434\u0435 \u0441\u043A\u043E\u0440\u043E \u043F\u043E\u044F\u0432\u0438\u0442\u0441\u044F \u043E\u0442\u043A\u0440\u044B\u0442\u0430\u044F \u043B\u0438\u043D\u0438\u044F? \u041A\u0430\u043A \u043F\u043E\u0434\u0433\u043E\u0442\u043E\u0432\u0438\u0442\u044C\u0441\u044F \u043A \u044D\u0442\u043E\u043C\u0443?",answer:"\u041B\u0438\u043D\u0438\u044F a. \u041D\u0430\u0434\u043E \u0442\u044F\u0436\u0435\u043B\u044B\u0435 \u0431\u0435\u043B\u044B\u0435 \u0444\u0438\u0433\u0443\u0440\u044B \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u043D\u0430 \u043B\u0438\u043D\u0438\u044E \u0430. \u041B\u0430\u0434\u044C\u0438 \u0432\u043F\u0435\u0440\u0435\u0434\u0438, \u0444\u0435\u0440\u0437\u044C \u043F\u043E\u0437\u0430\u0434\u0438.",fen:"2qrr1k1/p3p3/1p1p1p2/PPpP2p1/2P1P1Pp/5P1P/6K1/3RRQ2 w - - 0 1"}]},{name:"\u041F\u0435\u0448\u0435\u0447\u043D\u044B\u0435 \u0441\u043B\u0430\u0431\u043E\u0441\u0442\u0438",questions:[{value:100,question:"\u0415\u0441\u0442\u044C \u043B\u0438 \u0437\u0434\u0435\u0441\u044C \u043F\u0435\u0448\u0435\u0447\u043D\u0430\u044F \u0441\u043B\u0430\u0431\u043E\u0441\u0442\u044C?",answer:"\u0414\u0430, \u043F\u0435\u0448\u043A\u0438 c7 \u0438 c6, \u0441\u0434\u0432\u043E\u0435\u043D\u043D\u044B\u0435.",fen:"r1bqkb1r/ppp2ppp/2p2n2/4p3/4P3/5N2/PPPP1PPP/RNBQK2R w KQkq - 0 5"},{value:200,question:"\u0415\u0441\u0442\u044C \u043B\u0438 \u0437\u0434\u0435\u0441\u044C \u043F\u0435\u0448\u0435\u0447\u043D\u0430\u044F \u0441\u043B\u0430\u0431\u043E\u0441\u0442\u044C?",answer:"\u0414\u0430, \u043F\u0435\u0448\u043A\u0430 \u043D\u0430 e4 - \u0438\u0437\u043E\u043B\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u0430\u044F.",fen:"6k1/p5p1/1p3p2/2p1p3/4P3/8/PPP3PP/6K1 w - - 0 1"},{value:300,question:"\u041D\u0430\u0437\u043E\u0432\u0438 \u0432\u0441\u0435 \u043F\u0435\u0448\u0435\u0447\u043D\u044B\u0435 \u0441\u043B\u0430\u0431\u043E\u0441\u0442\u0438",answer:"\u041F\u0435\u0448\u043A\u0438 a3 \u0438 e2 - \u043E\u0442\u0441\u0442\u0430\u043B\u044B\u0435, \u043F\u0435\u0448\u043A\u0438 f4 \u0438 d6 - \u0438\u0437\u043E\u043B\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0435, \u043F\u0435\u0448\u043A\u0438 b5 \u0438 b6 - \u0441\u0434\u0432\u043E\u0435\u043D\u043D\u044B\u0435.",fen:"6k1/8/1p1p4/1p6/1P3p2/P4P2/4P3/6K1 w - - 0 1"},{value:400,question:"\u041A\u0430\u043A \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043F\u0435\u0448\u0435\u0447\u043D\u0443\u044E \u0441\u043B\u0430\u0431\u043E\u0441\u0442\u044C?",answer:"\u0421f6:g5",fen:"rnb2rk1/ppq2ppp/2pbpn2/3p2B1/2PP4/2NBPN2/PP3PPP/R2QK2R w KQ - 3 8"},{value:500,question:"\u041A\u0430\u043A \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043F\u0435\u0448\u0435\u0447\u043D\u0443\u044E \u0441\u043B\u0430\u0431\u043E\u0441\u0442\u044C?",answer:"b4!",fen:"8/p4k2/8/1p6/8/1P6/P7/7K w - - 0 1"}]},{name:"\u0421\u043B\u0430\u0431\u044B\u0435 \u043F\u043E\u043B\u044F",questions:[{value:100,question:"\u0413\u0434\u0435 \u0437\u0434\u0435\u0441\u044C \u0441\u043B\u0430\u0431\u043E\u0435 \u043F\u043E\u043B\u0435? \u041A\u0430\u043A \u0435\u0433\u043E \u0437\u0430\u043D\u044F\u0442\u044C?",answer:"\u041Ab3-c5",fen:"4b1k1/8/p1p3p1/Pp1p1pPp/1P1PpP1P/1N2P3/6K1/8 w - - 0 1"},{value:200,question:"\u041A\u0430\u043A \u0437\u0430\u043D\u044F\u0442\u044C \u0441\u043B\u0430\u0431\u043E\u0435 \u043F\u043E\u043B\u0435?",answer:"\u041Bc8-f8-f4",fen:"1kr4r/ppp5/3p3p/3Pp1pP/4P3/5P2/PPP5/1KR4R w - - 0 1"},{value:300,question:"\u0413\u0434\u0435 \u0437\u0434\u0435\u0441\u044C \u0441\u043B\u0430\u0431\u043E\u0435 \u043F\u043E\u043B\u0435? \u041A\u0430\u043A \u0435\u0433\u043E \u0437\u0430\u043D\u044F\u0442\u044C?",answer:"e6. \u041A\u0440e2-f3, \u041Bf1-\u04351, \u041Be1-e6",fen:"6kr/p5pp/Pp1p1p2/1PpP1P2/2P2P2/6P1/4K2P/5R2 w - - 0 1"},{value:400,question:"\u0413\u0434\u0435 \u0437\u0434\u0435\u0441\u044C \u0441\u043B\u0430\u0431\u044B\u0435 \u043F\u043E\u043B\u044F? \u041A\u0430\u043A \u0438\u0445 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C?",answer:"b2 \u0438 a3. \u0421b4-a3, \u0433\u0440\u043E\u0437\u0438\u0442 \u043C\u0430\u0442!",fen:"r1b2rk1/1p3p1p/p3pqp1/2p5/1bP1QNPP/1P2P3/P1B2P2/1K4RR b - - 0 14"},{value:500,question:"\u0413\u0434\u0435 \u0437\u0434\u0435\u0441\u044C \u0441\u043B\u0430\u0431\u043E\u0435 \u043F\u043E\u043B\u0435? \u041A\u0430\u043A \u0435\u0433\u043E \u0437\u0430\u043D\u044F\u0442\u044C?",answer:"e5. \u041Ab1-d2-f3-e5.",fen:"r3rnk1/pp1b2pp/2p4q/3p1p2/3P1P2/P1NBP3/1P3QPP/4RRK1 w - - 0 1"}]}]}];var Nt="jeopardy_saves",Gr="jeopardy_packs";function ne(){try{let e=localStorage.getItem(Gr);return e?JSON.parse(e):[]}catch{return[]}}function Qr(e){localStorage.setItem(Gr,JSON.stringify(e))}function Ht(e,t){let r=ne();t!==void 0&&t>=0?r[t]=e:r.push(e),Qr(r)}function Zr(e){let t=ne();t.splice(e,1),Qr(t)}function It(e){return{id:e.id,pack:e.pack,players:e.players,timerSecs:e.timerSecs,answered:[...e.answered]}}function Ei(e){return{id:e.id,pack:e.pack,players:e.players,timerSecs:e.timerSecs,answered:new Set(e.answered),cur:null}}function ze(){try{let e=localStorage.getItem(Nt);return e?JSON.parse(e).map(t=>({...t,state:Ei(t.state)})):[]}catch{return[]}}function Ci(e){let t=ze(),r=t.findIndex(i=>i.id===e.id),o={id:e.id,name:e.name,savedAt:e.savedAt,state:It(e.state)},n=t.map(i=>({id:i.id,name:i.name,savedAt:i.savedAt,state:It(i.state)}));r>=0?n[r]=o:n.push(o),localStorage.setItem(Nt,JSON.stringify(n))}function st(e){let t=ze().filter(r=>r.id!==e);localStorage.setItem(Nt,JSON.stringify(t.map(r=>({id:r.id,name:r.name,savedAt:r.savedAt,state:It(r.state)}))))}function at(e){let t=e.players.map(r=>r.name).join(", ");Ci({id:e.id,name:`${e.pack.title} \xB7 ${t}`,savedAt:Date.now(),state:e})}var qe=[...Fe,...ne()],Vr=Fe.length,Kt=0,Ot=["\u0418\u0433\u0440\u043E\u043A 1","\u0418\u0433\u0440\u043E\u043A 2"],Rt=0,L=null;function Ue(e){Kt=e}function Jr(e){Ot=e}function Yr(e){Rt=e}function lt(e){L=e}function Xr(e){qe.push(e)}function eo(){qe.splice(0,qe.length,...Fe,...ne())}function T(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function to(e){let t=e.trim();if(!t)return"";try{let r=new URL(t);if(r.protocol==="http:"||r.protocol==="https:")return t}catch{}return""}var qi="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 px-4",ro="bg-gray-900 border border-gray-700 rounded-2xl p-6 w-full shadow-2xl space-y-5";function oo(){let e=document.createElement("div");return e.className=qi,e}function We(e,t){let r=oo();r.innerHTML=`
    <div class="${ro}" style="max-width:380px">
      <p class="text-center text-white text-base leading-relaxed">${e}</p>
      <button id="modal-ok"
        class="w-full py-2.5 bg-blue-600 hover:bg-blue-500 rounded-xl border-0 text-white
               font-bold cursor-pointer transition-colors">
        \u041E\u041A
      </button>
    </div>
  `,document.body.appendChild(r);let o=()=>{r.remove(),t?.()};r.querySelector("#modal-ok").addEventListener("click",o),r.addEventListener("click",n=>{n.target===r&&o()})}function be(e,t,r){let o=oo(),n=r?.confirmLabel??"\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C",i=r?.confirmClass??"bg-red-600 hover:bg-red-500";o.innerHTML=`
    <div class="${ro}" style="max-width:380px">
      <p class="text-center text-white text-base leading-relaxed">${e}</p>
      <div class="flex gap-3">
        <button id="modal-cancel"
          class="flex-1 py-2.5 bg-gray-700 hover:bg-gray-600 rounded-xl border-0 text-white
                 cursor-pointer transition-colors">
          \u041E\u0442\u043C\u0435\u043D\u0430
        </button>
        <button id="modal-confirm"
          class="flex-1 py-2.5 ${i} rounded-xl border-0 text-white font-bold
                 cursor-pointer transition-colors">
          ${n}
        </button>
      </div>
    </div>
  `,document.body.appendChild(o);let s=()=>o.remove();o.querySelector("#modal-cancel").addEventListener("click",s),o.querySelector("#modal-confirm").addEventListener("click",()=>{s(),t()}),o.addEventListener("click",a=>{a.target===o&&s()})}function Dt(e){let t=ze().sort((r,o)=>o.savedAt-r.savedAt);e.innerHTML=`
    <div class="flex flex-col items-center justify-center min-h-screen gap-4 p-8">
      <h1 class="font-black text-yellow-400 text-center tracking-wider"
          style="font-size:clamp(3rem,12vw,6rem);line-height:1">
        \u0421\u0412\u041E\u042F \u0418\u0413\u0420\u0410
      </h1>
      <p class="text-gray-500 text-lg" style="margin-bottom:16px">
        \u0421\u043E\u0437\u0434\u0430\u0432\u0430\u0439 \u0432\u043E\u043F\u0440\u043E\u0441\u044B. \u0418\u0433\u0440\u0430\u0439 \u0441 \u0434\u0440\u0443\u0437\u044C\u044F\u043C\u0438.
      </p>

      <div class="flex flex-col gap-3 w-full max-w-xs">
        <button id="btn-new"
          class="py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-lg
                 transition-colors cursor-pointer border-0 text-white">
          \u041D\u043E\u0432\u0430\u044F \u0438\u0433\u0440\u0430
        </button>

        ${t.length>0?`
          <button id="btn-continue"
            class="py-4 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold text-lg
                   transition-colors cursor-pointer border-0 text-white">
            \u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C
          </button>
        `:""}

        <button id="btn-editor"
          class="py-4 bg-gray-700 hover:bg-gray-600 rounded-xl font-bold text-lg
                 transition-colors cursor-pointer border-0 text-white">
          \u0420\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u0432\u043E\u043F\u0440\u043E\u0441\u043E\u0432
        </button>
      </div>
    </div>
  `,e.querySelector("#btn-new").onclick=()=>A("setup"),e.querySelector("#btn-editor").onclick=()=>A("editor"),e.querySelector("#btn-continue")?.addEventListener("click",()=>{Ai(e,t)})}function Ai(e,t){document.getElementById("save-picker-modal")?.remove();let r=document.createElement("div");r.id="save-picker-modal",r.className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 px-4",r.innerHTML=`
    <div class="bg-gray-900 border border-gray-700 rounded-2xl p-6 w-full shadow-2xl space-y-4"
         style="max-width:420px">
      <h3 class="text-xl font-bold text-center">\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u0433\u0440\u0443</h3>
      <div class="space-y-2" style="max-height:18rem;overflow-y:auto">
        ${t.map(o=>`
          <div class="bg-gray-800 rounded-xl p-4 flex items-center gap-3">
            <div class="min-w-0 flex-1">
              <div class="font-bold text-sm truncate">${T(o.name)}</div>
              <div class="text-xs text-gray-400">${Li(o.savedAt)}</div>
            </div>
            <div class="flex gap-2 shrink-0">
              <button data-resume="${T(o.id)}"
                class="bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded-lg text-sm
                       font-bold transition-colors border-0 cursor-pointer text-white">\u25B6</button>
              <button data-del="${T(o.id)}"
                class="bg-red-700/80 hover:bg-red-600 px-3 py-1.5 rounded-lg text-sm
                       transition-colors border-0 cursor-pointer text-white">\u2715</button>
            </div>
          </div>
        `).join("")}
      </div>
      <button id="picker-close"
        class="w-full py-2.5 bg-gray-700 hover:bg-gray-600 rounded-xl text-sm
               transition-colors border-0 cursor-pointer text-white">
        \u0417\u0430\u043A\u0440\u044B\u0442\u044C
      </button>
    </div>
  `,document.body.appendChild(r),r.querySelectorAll("[data-resume]").forEach(o=>{o.addEventListener("click",()=>{let n=o.dataset.resume,i=ze().find(s=>s.id===n);i&&(ct(),lt(i.state),A("game-board"))})}),r.querySelectorAll("[data-del]").forEach(o=>{o.addEventListener("click",()=>{let n=o.dataset.del;be("\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u044D\u0442\u043E \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435?",()=>{st(n),ct(),Dt(e)},{confirmLabel:"\u0423\u0434\u0430\u043B\u0438\u0442\u044C"})})}),document.getElementById("picker-close")?.addEventListener("click",ct),r.addEventListener("click",o=>{o.target===r&&ct()})}function ct(){document.getElementById("save-picker-modal")?.remove()}function Li(e){return new Date(e).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}var ce=[];function jt(e){eo(),ce=[...Ot],Mi(e),Ft(e),Ti(e)}function Mi(e){e.innerHTML=`
    <div class="min-h-screen flex flex-col justify-center py-6 px-8" style="max-width:480px;margin:0 auto">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-bold">\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430 \u0438\u0433\u0440\u044B</h2>
        <button id="btn-back"
          class="text-blue-400 hover:text-blue-300 bg-transparent border-0 cursor-pointer text-base">
          \u2190 \u041D\u0430\u0437\u0430\u0434
        </button>
      </div>

      <div class="mb-6">
        <label class="block text-gray-400 text-sm mb-2">\u041D\u0430\u0431\u043E\u0440 \u0432\u043E\u043F\u0440\u043E\u0441\u043E\u0432</label>
        <div class="flex gap-2">
          <select id="pack-select"
            class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-white cursor-pointer">
            ${qe.map((t,r)=>`
              <option value="${r}" ${r===Kt?"selected":""}>
                ${T(t.title)} (${t.categories.length} \u043A\u0430\u0442.)
              </option>
            `).join("")}
          </select>
          <button id="btn-import"
            class="px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg border-0 text-white
                   cursor-pointer text-sm whitespace-nowrap">
            \u0418\u043C\u043F\u043E\u0440\u0442
          </button>
          <input type="file" id="file-input" accept=".json" class="hidden">
        </div>
      </div>

      <div class="mb-6">
        <label class="block text-gray-400 text-sm mb-2">\u0418\u0433\u0440\u043E\u043A\u0438</label>
        <div id="players-list" class="flex flex-col gap-2 mb-2"></div>
        <button id="btn-add-player"
          class="text-blue-400 hover:text-blue-300 bg-transparent border-0 cursor-pointer text-sm">
          + \u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0438\u0433\u0440\u043E\u043A\u0430
        </button>
      </div>

      <div class="mb-8">
        <label class="block text-gray-400 text-sm mb-2">
          \u0422\u0430\u0439\u043C\u0435\u0440 \u043D\u0430 \u0432\u043E\u043F\u0440\u043E\u0441 (\u0441\u0435\u043A), 0 = \u0431\u0435\u0437 \u0442\u0430\u0439\u043C\u0435\u0440\u0430
        </label>
        <input type="number" id="timer-input" value="${Rt}" min="0" max="600" step="5"
          class="w-24 bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-white">
      </div>

      <button id="btn-start"
        class="w-full py-4 bg-green-600 hover:bg-green-700 rounded-xl font-bold text-lg
               border-0 text-white cursor-pointer transition-colors">
        \u041D\u0430\u0447\u0430\u0442\u044C \u0438\u0433\u0440\u0443
      </button>
    </div>
  `}function Ft(e){let t=e.querySelector("#players-list");t.innerHTML=ce.map((r,o)=>`
    <div class="flex gap-2 items-center">
      <input type="text" value="${T(r)}" data-idx="${o}"
        class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-white">
      <button class="btn-remove text-red-400 bg-transparent border-0 cursor-pointer
                     text-xl px-2 hover:text-red-300" data-idx="${o}">\u2715</button>
    </div>
  `).join(""),t.querySelectorAll("input").forEach(r=>{r.oninput=()=>{ce[Number(r.dataset.idx)]=r.value}}),t.querySelectorAll(".btn-remove").forEach(r=>{r.onclick=()=>{ce.length<=1||(Bt(e),ce.splice(Number(r.dataset.idx),1),Ft(e))}})}function Bt(e){e.querySelectorAll("#players-list input").forEach((t,r)=>{ce[r]=t.value.trim()||`\u0418\u0433\u0440\u043E\u043A ${r+1}`})}function Ti(e){e.querySelector("#btn-back").addEventListener("click",()=>A("home")),e.querySelector("#btn-import").addEventListener("click",()=>{e.querySelector("#file-input").click()}),e.querySelector("#file-input").addEventListener("change",t=>{let r=t.target.files?.[0];if(!r)return;let o=new FileReader;o.onload=()=>{try{let n=JSON.parse(o.result);if(!n.title||!Array.isArray(n.categories))throw new Error('\u041D\u0435\u0442 \u043F\u043E\u043B\u0435\u0439 "title" \u0438\u043B\u0438 "categories"');Xr(n),Ue(qe.length-1),We(`\u041D\u0430\u0431\u043E\u0440 \xAB${n.title}\xBB \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D!`,()=>jt(e))}catch(n){We("\u041E\u0448\u0438\u0431\u043A\u0430 JSON: "+n.message)}},o.readAsText(r),t.target.value=""}),e.querySelector("#btn-add-player").addEventListener("click",()=>{Bt(e),ce.push(`\u0418\u0433\u0440\u043E\u043A ${ce.length+1}`),Ft(e)}),e.querySelector("#btn-start").addEventListener("click",()=>{Bt(e);let t=Number(e.querySelector("#pack-select").value),r=Number(e.querySelector("#timer-input").value)||0;Ue(t),Jr([...ce]),Yr(r);let o=qe[t],n=ce.map(s=>({name:s.trim()||"\u0418\u0433\u0440\u043E\u043A",score:0})),i={id:Date.now().toString(),pack:o,players:n,timerSecs:r,answered:new Set,cur:null};lt(i),at(i),A("game-board")})}function no(e){if(!L){A("home");return}e.innerHTML=`
    <div class="min-h-screen flex flex-col justify-center py-4 px-4 w-full"
         style="max-width:1280px;margin:0 auto">

      <div class="flex items-center justify-between mb-3">
        <h1 class="text-xl font-bold">\u0421\u0432\u043E\u044F \u0418\u0433\u0440\u0430</h1>
        <div class="flex gap-2 items-center">
          <button id="btn-finish"
            class="px-3 py-1.5 bg-red-600/80 hover:bg-red-500 rounded-lg border-0
                   text-white text-xs cursor-pointer transition-colors">
            \u0417\u0430\u0432\u0435\u0440\u0448\u0438\u0442\u044C
          </button>
          <button id="btn-home"
            class="text-gray-400 hover:text-white bg-transparent border-0 cursor-pointer text-xs">
            \u2190 \u0413\u043B\u0430\u0432\u043D\u0430\u044F
          </button>
        </div>
      </div>

      <div id="board-grid" class="gboard w-full"></div>

      <div id="scores-bar" class="mt-3 flex justify-center flex-wrap gap-3"></div>
    </div>
  `,$i(e),Ii(e),e.querySelector("#btn-finish").addEventListener("click",()=>A("results")),e.querySelector("#btn-home").addEventListener("click",()=>{be('\u0412\u0435\u0440\u043D\u0443\u0442\u044C\u0441\u044F \u043D\u0430 \u0433\u043B\u0430\u0432\u043D\u0443\u044E?<br><span class="text-gray-400 text-sm">\u041F\u0440\u043E\u0433\u0440\u0435\u0441\u0441 \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D.</span>',()=>A("home"),{confirmLabel:"\u041D\u0430 \u0433\u043B\u0430\u0432\u043D\u0443\u044E",confirmClass:"bg-blue-600 hover:bg-blue-500"})})}function $i(e){let t=L,r=t.pack.categories,o=[...new Set(r.flatMap(i=>i.questions.map(s=>s.value)))].sort((i,s)=>i-s),n=e.querySelector("#board-grid");n.style.gridTemplateColumns=`minmax(160px,260px) ${o.map(()=>"minmax(0,1fr)").join(" ")}`,r.forEach((i,s)=>{let a=document.createElement("div");a.className="cat-cell",a.textContent=i.name,n.appendChild(a),o.forEach(d=>{let c=i.questions.findIndex(g=>g.value===d),h=document.createElement("div");if(c===-1)h.className="val-cell done";else{let g=`${s}-${c}`,m=t.answered.has(g);h.className="val-cell"+(m?" done":""),m||(h.textContent=String(d),h.addEventListener("click",()=>{t.cur={catIdx:s,qIdx:c},A("question")}))}n.appendChild(h)})})}function Ii(e){let t=e.querySelector("#scores-bar");t.innerHTML=L.players.map(r=>`
    <div class="score-card">
      <div class="sc-name">${T(r.name)}</div>
      <div class="sc-val">${r.score}</div>
    </div>
  `).join("")}var io=["white","black"];var Ae=["a","b","c","d","e","f","g","h"],Re=["1","2","3","4","5","6","7","8"];var ao=[...Re].reverse(),dt=Array.prototype.concat(...Ae.map(e=>Re.map(t=>e+t))),G=e=>dt[8*e[0]+e[1]],E=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49];var ut=dt.map(E);function lo(e){let t,r=()=>(t===void 0&&(t=e()),t);return r.clear=()=>{t=void 0},r}var co=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;let t=performance.now()-e;return e=void 0,t}}},pt=e=>e==="white"?"black":"white",ve=(e,t)=>{let r=e[0]-t[0],o=e[1]-t[1];return r*r+o*o},Ge=(e,t)=>e.role===t.role&&e.color===t.color,xe=e=>(t,r)=>[(r?t[0]:7-t[0])*e.width/8,(r?7-t[1]:t[1])*e.height/8],ee=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},zt=(e,t,r=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${r})`},Qe=(e,t)=>{e.style.visibility=t?"visible":"hidden"},de=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},ft=e=>e.button===2,te=(e,t)=>{let r=document.createElement(e);return t&&(r.className=t),r};function ht(e,t,r){let o=E(e);return t||(o[0]=7-o[0],o[1]=7-o[1]),[r.left+r.width*o[0]/8+r.width/16,r.top+r.height*(7-o[1])/8+r.height/16]}var Le=(e,t)=>Math.abs(e-t),Ni=e=>(t,r,o,n)=>Le(t,o)<2&&(e==="white"?n===r+1||r<=1&&n===r+2&&t===o:n===r-1||r>=6&&n===r-2&&t===o),Ut=(e,t,r,o)=>{let n=Le(e,r),i=Le(t,o);return n===1&&i===2||n===2&&i===1},uo=(e,t,r,o)=>Le(e,r)===Le(t,o),po=(e,t,r,o)=>e===r||t===o,Wt=(e,t,r,o)=>uo(e,t,r,o)||po(e,t,r,o),Hi=(e,t,r)=>(o,n,i,s)=>Le(o,i)<2&&Le(n,s)<2||r&&n===s&&n===(e==="white"?0:7)&&(o===4&&(i===2&&t.includes(0)||i===6&&t.includes(7))||t.includes(i));function Ki(e,t){let r=t==="white"?"1":"8",o=[];for(let[n,i]of e)n[1]===r&&i.color===t&&i.role==="rook"&&o.push(E(n)[0]);return o}function Gt(e,t,r){let o=e.get(t);if(!o)return[];let n=E(t),i=o.role,s=i==="pawn"?Ni(o.color):i==="knight"?Ut:i==="bishop"?uo:i==="rook"?po:i==="queen"?Wt:Hi(o.color,Ki(e,o.color),r);return ut.filter(a=>(n[0]!==a[0]||n[1]!==a[1])&&s(n[0],n[1],a[0],a[1])).map(G)}function Z(e,...t){e&&setTimeout(()=>e(...t),1)}function fo(e){e.orientation=pt(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function ho(e,t){for(let[r,o]of t)o?e.pieces.set(r,o):e.pieces.delete(r)}function go(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(let[r,o]of e.pieces)o.role==="king"&&o.color===t&&(e.check=r)}function Oi(e,t,r,o){se(e),e.premovable.current=[t,r],Z(e.premovable.events.set,t,r,o)}function ie(e){e.premovable.current&&(e.premovable.current=void 0,Z(e.premovable.events.unset))}function Ri(e,t,r){ie(e),e.predroppable.current={role:t,key:r},Z(e.predroppable.events.set,t,r)}function se(e){let t=e.predroppable;t.current&&(t.current=void 0,Z(t.events.unset))}function Di(e,t,r){if(!e.autoCastle)return!1;let o=e.pieces.get(t);if(!o||o.role!=="king")return!1;let n=E(t),i=E(r);if(n[1]!==0&&n[1]!==7||n[1]!==i[1])return!1;n[0]===4&&!e.pieces.has(r)&&(i[0]===6?r=G([7,i[1]]):i[0]===2&&(r=G([0,i[1]])));let s=e.pieces.get(r);return!s||s.color!==o.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(r),n[0]<i[0]?(e.pieces.set(G([6,i[1]]),o),e.pieces.set(G([5,i[1]]),s)):(e.pieces.set(G([2,i[1]]),o),e.pieces.set(G([3,i[1]]),s)),!0)}function Qt(e,t,r){let o=e.pieces.get(t),n=e.pieces.get(r);if(t===r||!o)return!1;let i=n&&n.color!==o.color?n:void 0;return r===e.selected&&Q(e),Z(e.events.move,t,r,i),Di(e,t,r)||(e.pieces.set(r,o),e.pieces.delete(t)),e.lastMove=[t,r],e.check=void 0,Z(e.events.change),i||!0}function gt(e,t,r,o){if(e.pieces.has(r))if(o)e.pieces.delete(r);else return!1;return Z(e.events.dropNewPiece,t,r),e.pieces.set(r,t),e.lastMove=[r],e.check=void 0,Z(e.events.change),e.movable.dests=void 0,e.turnColor=pt(e.turnColor),!0}function mo(e,t,r){let o=Qt(e,t,r);return o&&(e.movable.dests=void 0,e.turnColor=pt(e.turnColor),e.animation.current=void 0),o}function Zt(e,t,r){if(bt(e,t,r)){let o=mo(e,t,r);if(o){let n=e.hold.stop();Q(e);let i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:n};return o!==!0&&(i.captured=o),Z(e.movable.events.after,t,r,i),!0}}else if(ji(e,t,r))return Oi(e,t,r,{ctrlKey:e.stats.ctrlKey}),Q(e),!0;return Q(e),!1}function mt(e,t,r,o){let n=e.pieces.get(t);n&&(Bi(e,t,r)||o)?(e.pieces.delete(t),gt(e,n,r,o),Z(e.movable.events.afterNewPiece,n.role,r,{premove:!1,predrop:!1})):n&&Fi(e,t,r)?Ri(e,n.role,r):(ie(e),se(e)),e.pieces.delete(t),Q(e)}function Ve(e,t,r){if(Z(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){Q(e),e.hold.cancel();return}else if((e.selectable.enabled||r)&&e.selected!==t&&Zt(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(bo(e,t)||Jt(e,t))&&(Vt(e,t),e.hold.start())}function Vt(e,t){e.selected=t,Jt(e,t)?e.premovable.customDests||(e.premovable.dests=Gt(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function Q(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function bo(e,t){let r=e.pieces.get(t);return!!r&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}var bt=(e,t,r)=>{var o,n;return t!==r&&bo(e,t)&&(e.movable.free||!!(!((n=(o=e.movable.dests)===null||o===void 0?void 0:o.get(t))===null||n===void 0)&&n.includes(r)))};function Bi(e,t,r){let o=e.pieces.get(t);return!!o&&(t===r||!e.pieces.has(r))&&(e.movable.color==="both"||e.movable.color===o.color&&e.turnColor===o.color)}function Jt(e,t){let r=e.pieces.get(t);return!!r&&e.premovable.enabled&&e.movable.color===r.color&&e.turnColor!==r.color}function ji(e,t,r){var o,n;let i=(n=(o=e.premovable.customDests)===null||o===void 0?void 0:o.get(t))!==null&&n!==void 0?n:Gt(e.pieces,t,e.premovable.castle);return t!==r&&Jt(e,t)&&i.includes(r)}function Fi(e,t,r){let o=e.pieces.get(t),n=e.pieces.get(r);return!!o&&(!n||n.color!==e.movable.color)&&e.predroppable.enabled&&(o.role!=="pawn"||r[1]!=="1"&&r[1]!=="8")&&e.movable.color===o.color&&e.turnColor!==o.color}function vo(e,t){let r=e.pieces.get(t);return!!r&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===r.color&&(e.turnColor===r.color||e.premovable.enabled))}function xo(e){let t=e.premovable.current;if(!t)return!1;let r=t[0],o=t[1],n=!1;if(bt(e,r,o)){let i=mo(e,r,o);if(i){let s={premove:!0};i!==!0&&(s.captured=i),Z(e.movable.events.after,r,o,s),n=!0}}return ie(e),n}function yo(e,t){let r=e.predroppable.current,o=!1;if(!r)return!1;if(t(r)){let n={role:r.role,color:e.movable.color};gt(e,n,r.key)&&(Z(e.movable.events.afterNewPiece,r.role,r.key,{premove:!1,predrop:!0}),o=!0)}return se(e),o}function Je(e){ie(e),se(e),Q(e)}function Yt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,Je(e)}function ae(e,t,r){let o=Math.floor(8*(e[0]-r.left)/r.width);t||(o=7-o);let n=7-Math.floor(8*(e[1]-r.top)/r.height);return t||(n=7-n),o>=0&&o<8&&n>=0&&n<8?G([o,n]):void 0}function wo(e,t,r,o){let n=E(e),i=ut.filter(c=>Wt(n[0],n[1],c[0],c[1])||Ut(n[0],n[1],c[0],c[1])),a=i.map(c=>ht(G(c),r,o)).map(c=>ve(t,c)),[,d]=a.reduce((c,h,g)=>c[0]<h?c:[h,g],[a[0],0]);return G(i[d])}var I=e=>e.orientation==="white";var er="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",zi={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Ui={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function vt(e){e==="start"&&(e=er);let t=new Map,r=7,o=0;for(let n of e)switch(n){case" ":case"[":return t;case"/":if(--r,r<0)return t;o=0;break;case"~":{let i=t.get(G([o-1,r]));i&&(i.promoted=!0);break}default:{let i=n.charCodeAt(0);if(i<57)o+=i-48;else{let s=n.toLowerCase();t.set(G([o,r]),{role:zi[s],color:n===s?"black":"white"}),++o}}}return t}function ko(e){return ao.map(t=>Ae.map(r=>{let o=e.get(r+t);if(o){let n=Ui[o.role];return o.color==="white"&&(n=n.toUpperCase()),o.promoted&&(n+="~"),n}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function tr(e,t){t.animation&&(rr(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function xt(e,t){var r,o,n;if(!((r=t.movable)===null||r===void 0)&&r.dests&&(e.movable.dests=void 0),!((o=t.drawable)===null||o===void 0)&&o.autoShapes&&(e.drawable.autoShapes=[]),rr(e,t),t.fen&&(e.pieces=vt(t.fen),e.drawable.shapes=((n=t.drawable)===null||n===void 0?void 0:n.shapes)||[]),"check"in t&&go(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Vt(e,e.selected),tr(e,t),!e.movable.rookCastle&&e.movable.dests){let i=e.movable.color==="white"?"1":"8",s="e"+i,a=e.movable.dests.get(s),d=e.pieces.get(s);if(!a||!d||d.role!=="king")return;e.movable.dests.set(s,a.filter(c=>!(c==="a"+i&&a.includes("c"+i))&&!(c==="h"+i&&a.includes("g"+i))))}}function rr(e,t){for(let r in t)r==="__proto__"||r==="constructor"||!Object.prototype.hasOwnProperty.call(t,r)||(Object.prototype.hasOwnProperty.call(e,r)&&_o(e[r])&&_o(t[r])?rr(e[r],t[r]):e[r]=t[r])}function _o(e){if(typeof e!="object"||e===null)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}var fe=(e,t)=>t.animation.enabled?Zi(e,t):he(e,t);function he(e,t){let r=e(t);return t.dom.redraw(),r}var or=(e,t)=>({key:e,pos:E(e),piece:t}),Gi=(e,t)=>t.sort((r,o)=>ve(e.pos,r.pos)-ve(e.pos,o.pos))[0];function Qi(e,t){let r=new Map,o=[],n=new Map,i=[],s=[],a=new Map,d,c,h;for(let[g,m]of e)a.set(g,or(g,m));for(let g of dt)d=t.pieces.get(g),c=a.get(g),d?c?Ge(d,c.piece)||(i.push(c),s.push(or(g,d))):s.push(or(g,d)):c&&i.push(c);for(let g of s)c=Gi(g,i.filter(m=>Ge(g.piece,m.piece))),c&&(h=[c.pos[0]-g.pos[0],c.pos[1]-g.pos[1]],r.set(g.key,h.concat(h)),o.push(c.key));for(let g of i)o.includes(g.key)||n.set(g.key,g.piece);return{anims:r,fadings:n}}function So(e,t){let r=e.animation.current;if(r===void 0){e.dom.destroyed||e.dom.redrawNow();return}let o=1-(t-r.start)*r.frequency;if(o<=0)e.animation.current=void 0,e.dom.redrawNow();else{let n=Vi(o);for(let i of r.plan.anims.values())i[2]=i[0]*n,i[3]=i[1]*n;e.dom.redrawNow(!0),requestAnimationFrame((i=performance.now())=>So(e,i))}}function Zi(e,t){let r=new Map(t.pieces),o=e(t),n=Qi(r,t);if(n.anims.size||n.fadings.size){let i=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:n},i||So(t,performance.now())}else t.dom.redraw();return o}var Vi=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1;var Ji=["green","red","blue","yellow"];function Po(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?Q(e):Je(e);let r=de(t),o=ae(r,I(e),e.dom.bounds());o&&(e.drawable.current={orig:o,pos:r,brush:Yi(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Eo(e))}function Eo(e){requestAnimationFrame(()=>{let t=e.drawable.current;if(t){let r=ae(t.pos,I(e),e.dom.bounds());r||(t.snapToValidMove=!1);let o=t.snapToValidMove?wo(t.orig,t.pos,I(e),e.dom.bounds()):r;o!==t.mouseSq&&(t.mouseSq=o,t.dest=o!==t.orig?o:void 0,e.dom.redrawNow()),Eo(e)}})}function Co(e,t){e.drawable.current&&(e.drawable.current.pos=de(t))}function qo(e){let t=e.drawable.current;t&&(t.mouseSq&&Xi(e.drawable,t),nr(e))}function nr(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Ao(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),Lo(e.drawable))}function Yi(e){var t;let r=(e.shiftKey||e.ctrlKey)&&ft(e),o=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return Ji[(r?1:0)+(o?2:0)]}function Xi(e,t){let r=n=>n.orig===t.orig&&n.dest===t.dest,o=e.shapes.find(r);o&&(e.shapes=e.shapes.filter(n=>!r(n))),(!o||o.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),Lo(e)}function Lo(e){e.onChange&&e.onChange(e.shapes)}function Mo(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;let r=e.dom.bounds(),o=de(t),n=ae(o,I(e),r);if(!n)return;let i=e.pieces.get(n),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!i||i.color!==e.turnColor)&&Ao(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||i||s||ts(e,o)))t.preventDefault();else if(t.touches)return;let a=!!e.premovable.current,d=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&bt(e,e.selected,n)?fe(g=>Ve(g,n),e):Ve(e,n);let c=e.selected===n,h=Ho(e,n);if(i&&h&&c&&vo(e,n)){e.draggable.current={orig:n,piece:i,origPos:o,pos:o,started:e.draggable.autoDistance&&e.stats.dragged,element:h,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},h.cgDragging=!0,h.classList.add("dragging");let g=e.dom.elements.ghost;g&&(g.className=`ghost ${i.color} ${i.role}`,ee(g,xe(r)(E(n),I(e))),Qe(g,!0)),ir(e)}else a&&ie(e),d&&se(e);e.dom.redraw()}function ts(e,t){let r=I(e),o=e.dom.bounds(),n=Math.pow(o.width/8,2);for(let i of e.pieces.keys()){let s=ht(i,r,o);if(ve(s,t)<=n)return!0}return!1}function To(e,t,r,o){e.pieces.set("a0",t),e.dom.redraw();let i=de(r);e.draggable.current={orig:"a0",piece:t,origPos:i,pos:i,started:!0,element:()=>Ho(e,"a0"),originTarget:r.target,newPiece:!0,force:!!o,keyHasChanged:!1},ir(e)}function ir(e){requestAnimationFrame(()=>{var t;let r=e.draggable.current;if(!r)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(r.orig)&&(e.animation.current=void 0);let o=e.pieces.get(r.orig);if(!o||!Ge(o,r.piece))Me(e);else if(!r.started&&ve(r.pos,r.origPos)>=Math.pow(e.draggable.distance,2)&&(r.started=!0),r.started){if(typeof r.element=="function"){let i=r.element();if(!i)return;i.cgDragging=!0,i.classList.add("dragging"),r.element=i}let n=e.dom.bounds();ee(r.element,[r.pos[0]-n.left-n.width/16,r.pos[1]-n.top-n.height/16]),r.keyHasChanged||(r.keyHasChanged=r.orig!==ae(r.pos,I(e),n))}ir(e)})}function $o(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=de(t))}function Io(e,t){let r=e.draggable.current;if(!r)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&r.originTarget!==t.target&&!r.newPiece){e.draggable.current=void 0;return}ie(e),se(e);let o=de(t)||r.pos,n=ae(o,I(e),e.dom.bounds());n&&r.started&&r.orig!==n?r.newPiece?mt(e,r.orig,n,r.force):(e.stats.ctrlKey=t.ctrlKey,Zt(e,r.orig,n)&&(e.stats.dragged=!0)):r.newPiece?e.pieces.delete(r.orig):e.draggable.deleteOnDropOff&&!n&&(e.pieces.delete(r.orig),Z(e.events.change)),(r.orig===r.previouslySelected||r.keyHasChanged)&&(r.orig===n||!n)?Q(e):e.selectable.enabled||Q(e),No(e),e.draggable.current=void 0,e.dom.redraw()}function Me(e){let t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,Q(e),No(e),e.dom.redraw())}function No(e){let t=e.dom.elements;t.ghost&&Qe(t.ghost,!1)}function Ho(e,t){let r=e.dom.elements.board.firstChild;for(;r;){if(r.cgKey===t&&r.tagName==="PIECE")return r;r=r.nextSibling}}function Oo(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{Ko(e,2),setTimeout(()=>Ko(e,void 0),120)},120)}function Ko(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Ro(e,t){function r(){fo(e),t()}return{set(o){o.orientation&&o.orientation!==e.orientation&&r(),tr(e,o),(o.fen?fe:he)(n=>xt(n,o),e)},state:e,getFen:()=>ko(e.pieces),toggleOrientation:r,setPieces(o){fe(n=>ho(n,o),e)},selectSquare(o,n){o?fe(i=>Ve(i,o,n),e):e.selected&&(Q(e),e.dom.redraw())},move(o,n){fe(i=>Qt(i,o,n),e)},newPiece(o,n){fe(i=>gt(i,o,n),e)},playPremove(){if(e.premovable.current){if(fe(xo,e))return!0;e.dom.redraw()}return!1},playPredrop(o){if(e.predroppable.current){let n=yo(e,o);return e.dom.redraw(),n}return!1},cancelPremove(){he(ie,e)},cancelPredrop(){he(se,e)},cancelMove(){he(o=>{Je(o),Me(o)},e)},stop(){he(o=>{Yt(o),Me(o)},e)},explode(o){Oo(e,o)},setAutoShapes(o){he(n=>n.drawable.autoShapes=o,e)},setShapes(o){he(n=>n.drawable.shapes=o,e)},getKeyAtDomPos(o){return ae(o,I(e),e.dom.bounds())},redrawAll:t,dragNewPiece(o,n,i){To(e,o,n,i)},destroy(){Yt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Do(){return{pieces:vt(er),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:co()}}var Bo={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function zo(){let e=N("defs"),t=j(N("filter"),{id:"cg-filter-blur"});return t.appendChild(j(N("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function Uo(e,t,r){var o;let n=e.drawable,i=n.current,s=i&&i.mouseSq?i:void 0,a=new Map,d=e.dom.bounds(),c=n.autoShapes.filter(b=>!b.piece);for(let b of n.shapes.concat(c).concat(s?[s]:[])){if(!b.dest)continue;let y=(o=a.get(b.dest))!==null&&o!==void 0?o:new Set,x=kt(wt(E(b.orig),e.orientation),d),$=kt(wt(E(b.dest),e.orientation),d);y.add(ar(x,$)),a.set(b.dest,y)}let h=n.shapes.concat(c).map(b=>({shape:b,current:!1,hash:jo(b,sr(b.dest,a),!1,d)}));s&&h.push({shape:s,current:!0,hash:jo(s,sr(s.dest,a),!0,d)});let g=h.map(b=>b.hash).join(";");if(g===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=g;let m=t.querySelector("defs");os(n,h,m),ns(h,t.querySelector("g"),r.querySelector("g"),b=>as(e,b,n.brushes,a,d))}function os(e,t,r){var o;let n=new Map,i;for(let d of t.filter(c=>c.shape.dest&&c.shape.brush))i=Wo(e.brushes[d.shape.brush],d.shape.modifiers),!((o=d.shape.modifiers)===null||o===void 0)&&o.hilite&&n.set(yt(i).key,yt(i)),n.set(i.key,i);let s=new Set,a=r.firstElementChild;for(;a;)s.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(let[d,c]of n.entries())s.has(d)||r.appendChild(ds(c))}function ns(e,t,r,o){let n=new Map;for(let i of e)n.set(i.hash,!1);for(let i of[t,r]){let s=[],a=i.firstElementChild,d;for(;a;)d=a.getAttribute("cgHash"),n.has(d)?n.set(d,!0):s.push(a),a=a.nextElementSibling;for(let c of s)i.removeChild(c)}for(let i of e.filter(s=>!n.get(s.hash)))for(let s of o(i))s.isCustom?r.appendChild(s.el):t.appendChild(s.el)}function jo({orig:e,dest:t,brush:r,piece:o,modifiers:n,customSvg:i,label:s},a,d,c){var h,g;return[c.width,c.height,d,e,t,r,a&&"-",o&&is(o),n&&ss(n),i&&`custom-${Fo(i.html)},${(g=(h=i.center)===null||h===void 0?void 0:h[0])!==null&&g!==void 0?g:"o"}`,s&&`label-${Fo(s.text)}`].filter(m=>m).join(",")}function is(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function ss(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function Fo(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r)>>>0;return t.toString()}function as(e,{shape:t,current:r,hash:o},n,i,s){var a,d;let c=kt(wt(E(t.orig),e.orientation),s),h=t.dest?kt(wt(E(t.dest),e.orientation),s):c,g=t.brush&&Wo(n[t.brush],t.modifiers),m=i.get(t.dest),b=[];if(g){let y=j(N("g"),{cgHash:o});b.push({el:y}),c[0]!==h[0]||c[1]!==h[1]?y.appendChild(cs(t,g,c,h,r,sr(t.dest,i))):y.appendChild(ls(n[t.brush],c,r,s))}if(t.label){let y=t.label;(a=y.fill)!==null&&a!==void 0||(y.fill=t.brush&&n[t.brush].color);let x=t.brush?void 0:"tr";b.push({el:us(y,o,c,h,m,x),isCustom:!0})}if(t.customSvg){let y=(d=t.customSvg.center)!==null&&d!==void 0?d:"orig",[x,$]=y==="label"?Qo(c,h,m).map(D=>D-.5):y==="dest"?h:c,z=j(N("g"),{transform:`translate(${x},${$})`,cgHash:o});z.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,b.push({el:z,isCustom:!0})}return b}function ls(e,t,r,o){let n=ps(),i=(o.width+o.height)/(4*Math.max(o.width,o.height));return j(N("circle"),{stroke:e.color,"stroke-width":n[r?0:1],fill:"none",opacity:Go(e,r),cx:t[0],cy:t[1],r:i-n[1]/2})}function yt(e){return["#ffffff","#fff","white"].includes(e.color)?Bo.hilitePrimary:Bo.hiliteWhite}function cs(e,t,r,o,n,i){var s;function a(h){var g;let m=hs(i&&!n),b=o[0]-r[0],y=o[1]-r[1],x=Math.atan2(y,b),$=Math.cos(x)*m,z=Math.sin(x)*m;return j(N("line"),{stroke:h?yt(t).color:t.color,"stroke-width":fs(t,n)+(h?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${h?yt(t).key:t.key})`,opacity:!((g=e.modifiers)===null||g===void 0)&&g.hilite?1:Go(t,n),x1:r[0],y1:r[1],x2:o[0]-$,y2:o[1]-z})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return a(!1);let d=N("g"),c=j(N("g"),{filter:"url(#cg-filter-blur)"});return c.appendChild(gs(r,o)),c.appendChild(a(!0)),d.appendChild(c),d.appendChild(a(!1)),d}function ds(e){let t=j(N("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(j(N("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function us(e,t,r,o,n,i){var s;let d=.4*.75**e.text.length,c=Qo(r,o,n),h=i==="tr"?.4:0,g=j(N("g"),{transform:`translate(${c[0]+h},${c[1]-h})`,cgHash:t});g.appendChild(j(N("circle"),{r:.4/2,"fill-opacity":i?1:.8,"stroke-opacity":i?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));let m=j(N("text"),{"font-size":d,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return m.innerHTML=e.text,g.appendChild(m),g}function wt(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function sr(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function N(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function j(e,t){for(let r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.setAttribute(r,t[r]);return e}function Wo(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(r=>r).join("")}:e}function ps(){return[3/64,4/64]}function fs(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function Go(e,t){return(e.opacity||1)*(t?.9:1)}function hs(e){return(e?20:10)/64}function kt(e,t){let r=Math.min(1,t.width/t.height),o=Math.min(1,t.height/t.width);return[(e[0]-3.5)*r,(3.5-e[1])*o]}function gs(e,t){let r={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return j(N("rect"),{x:r.from[0],y:r.from[1],width:r.to[0]-r.from[0],height:r.to[1]-r.from[1],fill:"none",stroke:"none"})}function ar(e,t,r=!0){let o=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return r?(Math.round(o*8/Math.PI)+16)%16:o}function ms(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((r,o)=>r+o*o,0))}function Qo(e,t,r){let o=ms(e,t),n=ar(e,t,!1);if(r&&(o-=33/64,r.size>1)){o-=10/64;let i=ar(e,t);(r.has((i+1)%16)||r.has((i+15)%16))&&i&1&&(o-=.4)}return[e[0]-Math.cos(n)*o,e[1]-Math.sin(n)*o].map(i=>i+.5)}function Zo(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(let d of io)e.classList.toggle("orientation-"+d,t.orientation===d);e.classList.toggle("manipulable",!t.viewOnly);let r=te("cg-container");e.appendChild(r);let o=te("cg-board");r.appendChild(o);let n,i,s;if(t.drawable.visible&&(n=j(N("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),n.appendChild(zo()),n.appendChild(N("g")),i=j(N("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(N("g")),s=te("cg-auto-pieces"),r.appendChild(n),r.appendChild(i),r.appendChild(s)),t.coordinates){let d=t.orientation==="black"?" black":"",c=t.ranksPosition==="left"?" left":"";if(t.coordinatesOnSquares){let h=t.orientation==="white"?g=>g+1:g=>8-g;Ae.forEach((g,m)=>r.appendChild(lr(Re.map(b=>g+b),"squares rank"+h(m)+d+c)))}else r.appendChild(lr(Re,"ranks"+d+c)),r.appendChild(lr(Ae,"files"+d))}let a;return t.draggable.enabled&&t.draggable.showGhost&&(a=te("piece","ghost"),Qe(a,!1),r.appendChild(a)),{board:o,container:r,wrap:e,ghost:a,svg:n,customSvg:i,autoPieces:s}}function lr(e,t){let r=te("coords",t),o;for(let n of e)o=te("coord"),o.textContent=n,r.appendChild(o);return r}function Vo(e,t){if(!e.dropmode.active)return;ie(e),se(e);let r=e.dropmode.piece;if(r){e.pieces.set("a0",r);let o=de(t),n=o&&ae(o,I(e),e.dom.bounds());n&&mt(e,"a0",n)}e.dom.redraw()}function Yo(e,t){let r=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&r.addEventListener("contextmenu",n=>n.preventDefault()),e.viewOnly)return;let o=vs(e);r.addEventListener("touchstart",o,{passive:!1}),r.addEventListener("mousedown",o,{passive:!1})}function Xo(e,t){let r=[];if("ResizeObserver"in window||r.push(Ye(document.body,"chessground.resize",t)),!e.viewOnly){let o=Jo(e,$o,Co),n=Jo(e,Io,qo);for(let s of["touchmove","mousemove"])r.push(Ye(document,s,o));for(let s of["touchend","mouseup"])r.push(Ye(document,s,n));let i=()=>e.dom.bounds.clear();r.push(Ye(document,"scroll",i,{capture:!0,passive:!0})),r.push(Ye(window,"resize",i,{passive:!0}))}return()=>r.forEach(o=>o())}function Ye(e,t,r,o){return e.addEventListener(t,r,o),()=>e.removeEventListener(t,r,o)}var vs=e=>t=>{e.draggable.current?Me(e):e.drawable.current?nr(e):t.shiftKey||ft(t)?e.drawable.enabled&&Po(e,t):e.viewOnly||(e.dropmode.active?Vo(e,t):Mo(e,t))},Jo=(e,t,r)=>o=>{e.drawable.current?e.drawable.enabled&&r(e,o):e.viewOnly||t(e,o)};function tn(e){let t=I(e),r=xe(e.dom.bounds()),o=e.dom.elements.board,n=e.pieces,i=e.animation.current,s=i?i.plan.anims:new Map,a=i?i.plan.fadings:new Map,d=e.draggable.current,c=ys(e),h=new Set,g=new Set,m=new Map,b=new Map,y,x,$,z,D,Pe,Ne,V,He,Ke;for(x=o.firstChild;x;){if(y=x.cgKey,on(x))if($=n.get(y),D=s.get(y),Pe=a.get(y),z=x.cgPiece,x.cgDragging&&(!d||d.orig!==y)&&(x.classList.remove("dragging"),ee(x,r(E(y),t)),x.cgDragging=!1),!Pe&&x.cgFading&&(x.cgFading=!1,x.classList.remove("fading")),$){if(D&&x.cgAnimating&&z===Xe($)){let q=E(y);q[0]+=D[2],q[1]+=D[3],x.classList.add("anim"),ee(x,r(q,t))}else x.cgAnimating&&(x.cgAnimating=!1,x.classList.remove("anim"),ee(x,r(E(y),t)),e.addPieceZIndex&&(x.style.zIndex=cr(E(y),t)));z===Xe($)&&(!Pe||!x.cgFading)?h.add(y):Pe&&z===Xe(Pe)?(x.classList.add("fading"),x.cgFading=!0):dr(m,z,x)}else dr(m,z,x);else if(nn(x)){let q=x.className;c.get(y)===q?g.add(y):dr(b,q,x)}x=x.nextSibling}for(let[q,me]of c)if(!g.has(q)){He=b.get(me),Ke=He&&He.pop();let U=r(E(q),t);if(Ke)Ke.cgKey=q,ee(Ke,U);else{let J=te("square",me);J.cgKey=q,ee(J,U),o.insertBefore(J,o.firstChild)}}for(let[q,me]of n)if(D=s.get(q),!h.has(q))if(Ne=m.get(Xe(me)),V=Ne&&Ne.pop(),V){V.cgKey=q,V.cgFading&&(V.classList.remove("fading"),V.cgFading=!1);let U=E(q);e.addPieceZIndex&&(V.style.zIndex=cr(U,t)),D&&(V.cgAnimating=!0,V.classList.add("anim"),U[0]+=D[2],U[1]+=D[3]),ee(V,r(U,t))}else{let U=Xe(me),J=te("piece",U),Ee=E(q);J.cgPiece=U,J.cgKey=q,D&&(J.cgAnimating=!0,Ee[0]+=D[2],Ee[1]+=D[3]),ee(J,r(Ee,t)),e.addPieceZIndex&&(J.style.zIndex=cr(Ee,t)),o.appendChild(J)}for(let q of m.values())en(e,q);for(let q of b.values())en(e,q)}function rn(e){let t=I(e),r=xe(e.dom.bounds()),o=e.dom.elements.board.firstChild;for(;o;)(on(o)&&!o.cgAnimating||nn(o))&&ee(o,r(E(o.cgKey),t)),o=o.nextSibling}function ur(e){var t,r;let o=e.dom.elements.wrap.getBoundingClientRect(),n=e.dom.elements.container,i=o.height/o.width,s=Math.floor(o.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,a=s*i;n.style.width=s+"px",n.style.height=a+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("---cg-width",s+"px"),(r=e.addDimensionsCssVarsTo)===null||r===void 0||r.style.setProperty("---cg-height",a+"px")}var on=e=>e.tagName==="PIECE",nn=e=>e.tagName==="SQUARE";function en(e,t){for(let r of t)e.dom.elements.board.removeChild(r)}function cr(e,t){let o=e[1];return`${t?10-o:3+o}`}var Xe=e=>`${e.color} ${e.role}`;function ys(e){var t,r,o;let n=new Map;if(e.lastMove&&e.highlight.lastMove)for(let a of e.lastMove)ge(n,a,"last-move");if(e.check&&e.highlight.check&&ge(n,e.check,"check"),e.selected&&(ge(n,e.selected,"selected"),e.movable.showDests)){let a=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(a)for(let c of a)ge(n,c,"move-dest"+(e.pieces.has(c)?" oc":""));let d=(o=(r=e.premovable.customDests)===null||r===void 0?void 0:r.get(e.selected))!==null&&o!==void 0?o:e.premovable.dests;if(d)for(let c of d)ge(n,c,"premove-dest"+(e.pieces.has(c)?" oc":""))}let i=e.premovable.current;if(i)for(let a of i)ge(n,a,"current-premove");else e.predroppable.current&&ge(n,e.predroppable.current.key,"current-premove");let s=e.exploding;if(s)for(let a of s.keys)ge(n,a,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((a,d)=>{ge(n,d,a)}),n}function ge(e,t,r){let o=e.get(t);o?e.set(t,`${o} ${r}`):e.set(t,r)}function dr(e,t,r){let o=e.get(t);o?o.push(r):e.set(t,[r])}function sn(e,t,r){let o=new Map,n=[];for(let a of e)o.set(a.hash,!1);let i=t.firstElementChild,s;for(;i;)s=i.getAttribute("cgHash"),o.has(s)?o.set(s,!0):n.push(i),i=i.nextElementSibling;for(let a of n)t.removeChild(a);for(let a of e)o.get(a.hash)||t.appendChild(r(a))}function an(e,t){let o=e.drawable.autoShapes.filter(n=>n.piece).map(n=>({shape:n,hash:ks(n),current:!1}));sn(o,t,n=>ws(e,n,e.dom.bounds()))}function ln(e){var t;let r=I(e),o=xe(e.dom.bounds()),n=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;n;)zt(n,o(E(n.cgKey),r),n.cgScale),n=n.nextSibling}function ws(e,{shape:t,hash:r},o){var n,i,s;let a=t.orig,d=(n=t.piece)===null||n===void 0?void 0:n.role,c=(i=t.piece)===null||i===void 0?void 0:i.color,h=(s=t.piece)===null||s===void 0?void 0:s.scale,g=te("piece",`${d} ${c}`);return g.setAttribute("cgHash",r),g.cgKey=a,g.cgScale=h,zt(g,xe(o)(E(a),I(e)),h),g}var ks=e=>{var t,r,o;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(r=e.piece)===null||r===void 0?void 0:r.color,(o=e.piece)===null||o===void 0?void 0:o.scale].join(",")};function cn(e,t){let r=Do();xt(r,t||{});function o(){let n="dom"in r?r.dom.unbind:void 0,i=Zo(e,r),s=lo(()=>i.board.getBoundingClientRect()),a=h=>{tn(c),i.autoPieces&&an(c,i.autoPieces),!h&&i.svg&&Uo(c,i.svg,i.customSvg)},d=()=>{ur(c),rn(c),i.autoPieces&&ln(c)},c=r;return c.dom={elements:i,bounds:s,redraw:Ss(a),redrawNow:a,unbind:n},c.drawable.prevSvgHash="",ur(c),a(!1),Yo(c,d),n||(c.dom.unbind=Xo(c,d)),c.events.insert&&c.events.insert(i),c}return Ro(o(),o)}function Ss(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}function Ps(e){return e!==null?{comment:e,variations:[]}:{variations:[]}}function Es(e,t,r,o,n){let i={move:e,variations:n};return t&&(i.suffix=t),r&&(i.nag=r),o!==null&&(i.comment=o),i}function Cs(...e){let[t,...r]=e,o=t;for(let n of r)n!==null&&(o.variations=[n,...n.variations],n.variations=[],o=n);return t}function qs(e,t){if(t.marker&&t.marker.comment){let r=t.root;for(;;){let o=r.variations[0];if(!o){r.comment=t.marker.comment;break}r=o}}return{headers:e,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function As(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}function Be(e,t,r,o){var n=Error.call(this,e);return Object.setPrototypeOf&&Object.setPrototypeOf(n,Be.prototype),n.expected=t,n.found=r,n.location=o,n.name="SyntaxError",n}As(Be,Error);function pr(e,t,r){return r=r||" ",e.length>t?e:(t-=e.length,r+=r.repeat(t),e+r.slice(0,t))}Be.prototype.format=function(e){var t="Error: "+this.message;if(this.location){var r=null,o;for(o=0;o<e.length;o++)if(e[o].source===this.location.source){r=e[o].text.split(/\r\n|\n|\r/g);break}var n=this.location.start,i=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(n):n,s=this.location.source+":"+i.line+":"+i.column;if(r){var a=this.location.end,d=pr("",i.line.toString().length," "),c=r[n.line-1],h=n.line===a.line?a.column:c.length+1,g=h-n.column||1;t+=`
 --> `+s+`
`+d+` |
`+i.line+" | "+c+`
`+d+" | "+pr("",n.column-1," ")+pr("",g,"^")}else t+=`
 at `+s}return t};Be.buildMessage=function(e,t){var r={literal:function(c){return'"'+n(c.text)+'"'},class:function(c){var h=c.parts.map(function(g){return Array.isArray(g)?i(g[0])+"-"+i(g[1]):i(g)});return"["+(c.inverted?"^":"")+h.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(c){return c.description}};function o(c){return c.charCodeAt(0).toString(16).toUpperCase()}function n(c){return c.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+o(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+o(h)})}function i(c){return c.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+o(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+o(h)})}function s(c){return r[c.type](c)}function a(c){var h=c.map(s),g,m;if(h.sort(),h.length>0){for(g=1,m=1;g<h.length;g++)h[g-1]!==h[g]&&(h[m]=h[g],m++);h.length=m}switch(h.length){case 1:return h[0];case 2:return h[0]+" or "+h[1];default:return h.slice(0,-1).join(", ")+", or "+h[h.length-1]}}function d(c){return c?'"'+n(c)+'"':"end of input"}return"Expected "+a(e)+" but "+d(t)+" found."};function Ls(e,t){t=t!==void 0?t:{};var r={},o=t.grammarSource,n={pgn:Rr},i=Rr,s="[",a='"',d="]",c=".",h="O-O-O",g="O-O",m="0-0-0",b="0-0",y="$",x="{",$="}",z=";",D="(",Pe=")",Ne="1-0",V="0-1",He="1/2-1/2",Ke="*",q=/^[a-zA-Z]/,me=/^[^"]/,U=/^[0-9]/,J=/^[.]/,Ee=/^[a-zA-Z1-8\-=]/,En=/^[+#]/,Pr=/^[!?]/,Er=/^[^}]/,Cr=/^[^\r\n]/,qr=/^[ \t\r\n]/,Cn=X("tag pair"),qn=O("[",!1),Ar=O('"',!1),An=O("]",!1),Ln=X("tag name"),Mt=le([["a","z"],["A","Z"]],!1,!1),Mn=X("tag value"),Lr=le(['"'],!0,!1),Tn=X("move number"),ot=le([["0","9"]],!1,!1),$n=O(".",!1),Mr=le(["."],!1,!1),In=X("standard algebraic notation"),Nn=O("O-O-O",!1),Hn=O("O-O",!1),Kn=O("0-0-0",!1),On=O("0-0",!1),Tr=le([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Rn=le(["+","#"],!1,!1),Dn=X("suffix annotation"),$r=le(["!","?"],!1,!1),Bn=X("NAG"),jn=O("$",!1),Fn=X("brace comment"),zn=O("{",!1),Ir=le(["}"],!0,!1),Un=O("}",!1),Wn=X("rest of line comment"),Gn=O(";",!1),Nr=le(["\r",`
`],!0,!1),Qn=X("variation"),Zn=O("(",!1),Vn=O(")",!1),Jn=X("game termination marker"),Yn=O("1-0",!1),Xn=O("0-1",!1),ei=O("1/2-1/2",!1),ti=O("*",!1),ri=X("whitespace"),Hr=le([" ","	","\r",`
`],!1,!1),oi=function(l,p){return qs(l,p)},ni=function(l){return Object.fromEntries(l)},ii=function(l,p){return[l,p]},si=function(l,p){return{root:l,marker:p}},ai=function(l,p){return Cs(Ps(l),...p.flat())},li=function(l,p,f,k,_){return Es(l,p,f,k,_)},ci=function(l){return l},di=function(l){return l.replace(/[\r\n]+/g," ")},ui=function(l){return l.trim()},pi=function(l){return l},fi=function(l,p){return{result:l,comment:p}},u=t.peg$currPos|0,Oe=[{line:1,column:1}],oe=u,nt=t.peg$maxFailExpected||[],v=t.peg$silentFails|0,je;if(t.startRule){if(!(t.startRule in n))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');i=n[t.startRule]}function O(l,p){return{type:"literal",text:l,ignoreCase:p}}function le(l,p,f){return{type:"class",parts:l,inverted:p,ignoreCase:f}}function hi(){return{type:"end"}}function X(l){return{type:"other",description:l}}function Kr(l){var p=Oe[l],f;if(p)return p;if(l>=Oe.length)f=Oe.length-1;else for(f=l;!Oe[--f];);for(p=Oe[f],p={line:p.line,column:p.column};f<l;)e.charCodeAt(f)===10?(p.line++,p.column=1):p.column++,f++;return Oe[l]=p,p}function Or(l,p,f){var k=Kr(l),_=Kr(p),C={source:o,start:{offset:l,line:k.line,column:k.column},end:{offset:p,line:_.line,column:_.column}};return C}function w(l){u<oe||(u>oe&&(oe=u,nt=[]),nt.push(l))}function gi(l,p,f){return new Be(Be.buildMessage(l,p),l,p,f)}function Rr(){var l,p,f;return l=u,p=mi(),f=xi(),l=oi(p,f),l}function mi(){var l,p,f;for(l=u,p=[],f=Dr();f!==r;)p.push(f),f=Dr();return f=W(),l=ni(p),l}function Dr(){var l,p,f,k,_,C,Ce;return v++,l=u,W(),e.charCodeAt(u)===91?(p=s,u++):(p=r,v===0&&w(qn)),p!==r?(W(),f=bi(),f!==r?(W(),e.charCodeAt(u)===34?(k=a,u++):(k=r,v===0&&w(Ar)),k!==r?(_=vi(),e.charCodeAt(u)===34?(C=a,u++):(C=r,v===0&&w(Ar)),C!==r?(W(),e.charCodeAt(u)===93?(Ce=d,u++):(Ce=r,v===0&&w(An)),Ce!==r?l=ii(f,_):(u=l,l=r)):(u=l,l=r)):(u=l,l=r)):(u=l,l=r)):(u=l,l=r),v--,l===r&&v===0&&w(Cn),l}function bi(){var l,p,f;if(v++,l=u,p=[],f=e.charAt(u),q.test(f)?u++:(f=r,v===0&&w(Mt)),f!==r)for(;f!==r;)p.push(f),f=e.charAt(u),q.test(f)?u++:(f=r,v===0&&w(Mt));else p=r;return p!==r?l=e.substring(l,u):l=p,v--,l===r&&(p=r,v===0&&w(Ln)),l}function vi(){var l,p,f;for(v++,l=u,p=[],f=e.charAt(u),me.test(f)?u++:(f=r,v===0&&w(Lr));f!==r;)p.push(f),f=e.charAt(u),me.test(f)?u++:(f=r,v===0&&w(Lr));return l=e.substring(l,u),v--,p=r,v===0&&w(Mn),l}function xi(){var l,p,f;return l=u,p=Br(),W(),f=Pi(),f===r&&(f=null),W(),l=si(p,f),l}function Br(){var l,p,f,k;for(l=u,p=Tt(),p===r&&(p=null),f=[],k=jr();k!==r;)f.push(k),k=jr();return l=ai(p,f),l}function jr(){var l,p,f,k,_,C,Ce,it;if(l=u,W(),yi(),W(),p=wi(),p!==r){for(f=ki(),f===r&&(f=null),k=[],_=Fr();_!==r;)k.push(_),_=Fr();for(_=W(),C=Tt(),C===r&&(C=null),Ce=[],it=zr();it!==r;)Ce.push(it),it=zr();l=li(p,f,k,C,Ce)}else u=l,l=r;return l}function yi(){var l,p,f,k,_,C;for(v++,l=u,p=[],f=e.charAt(u),U.test(f)?u++:(f=r,v===0&&w(ot));f!==r;)p.push(f),f=e.charAt(u),U.test(f)?u++:(f=r,v===0&&w(ot));if(e.charCodeAt(u)===46?(f=c,u++):(f=r,v===0&&w($n)),f!==r){for(k=W(),_=[],C=e.charAt(u),J.test(C)?u++:(C=r,v===0&&w(Mr));C!==r;)_.push(C),C=e.charAt(u),J.test(C)?u++:(C=r,v===0&&w(Mr));p=[p,f,k,_],l=p}else u=l,l=r;return v--,l===r&&(p=r,v===0&&w(Tn)),l}function wi(){var l,p,f,k,_,C;if(v++,l=u,p=u,e.substr(u,5)===h?(f=h,u+=5):(f=r,v===0&&w(Nn)),f===r&&(e.substr(u,3)===g?(f=g,u+=3):(f=r,v===0&&w(Hn)),f===r&&(e.substr(u,5)===m?(f=m,u+=5):(f=r,v===0&&w(Kn)),f===r&&(e.substr(u,3)===b?(f=b,u+=3):(f=r,v===0&&w(On)),f===r))))if(f=u,k=e.charAt(u),q.test(k)?u++:(k=r,v===0&&w(Mt)),k!==r){if(_=[],C=e.charAt(u),Ee.test(C)?u++:(C=r,v===0&&w(Tr)),C!==r)for(;C!==r;)_.push(C),C=e.charAt(u),Ee.test(C)?u++:(C=r,v===0&&w(Tr));else _=r;_!==r?(k=[k,_],f=k):(u=f,f=r)}else u=f,f=r;return f!==r?(k=e.charAt(u),En.test(k)?u++:(k=r,v===0&&w(Rn)),k===r&&(k=null),f=[f,k],p=f):(u=p,p=r),p!==r?l=e.substring(l,u):l=p,v--,l===r&&(p=r,v===0&&w(In)),l}function ki(){var l,p,f;for(v++,l=u,p=[],f=e.charAt(u),Pr.test(f)?u++:(f=r,v===0&&w($r));f!==r;)p.push(f),p.length>=2?f=r:(f=e.charAt(u),Pr.test(f)?u++:(f=r,v===0&&w($r)));return p.length<1?(u=l,l=r):l=p,v--,l===r&&(p=r,v===0&&w(Dn)),l}function Fr(){var l,p,f,k,_;if(v++,l=u,W(),e.charCodeAt(u)===36?(p=y,u++):(p=r,v===0&&w(jn)),p!==r){if(f=u,k=[],_=e.charAt(u),U.test(_)?u++:(_=r,v===0&&w(ot)),_!==r)for(;_!==r;)k.push(_),_=e.charAt(u),U.test(_)?u++:(_=r,v===0&&w(ot));else k=r;k!==r?f=e.substring(f,u):f=k,f!==r?l=ci(f):(u=l,l=r)}else u=l,l=r;return v--,l===r&&v===0&&w(Bn),l}function Tt(){var l;return l=_i(),l===r&&(l=Si()),l}function _i(){var l,p,f,k,_;if(v++,l=u,e.charCodeAt(u)===123?(p=x,u++):(p=r,v===0&&w(zn)),p!==r){for(f=u,k=[],_=e.charAt(u),Er.test(_)?u++:(_=r,v===0&&w(Ir));_!==r;)k.push(_),_=e.charAt(u),Er.test(_)?u++:(_=r,v===0&&w(Ir));f=e.substring(f,u),e.charCodeAt(u)===125?(k=$,u++):(k=r,v===0&&w(Un)),k!==r?l=di(f):(u=l,l=r)}else u=l,l=r;return v--,l===r&&(p=r,v===0&&w(Fn)),l}function Si(){var l,p,f,k,_;if(v++,l=u,e.charCodeAt(u)===59?(p=z,u++):(p=r,v===0&&w(Gn)),p!==r){for(f=u,k=[],_=e.charAt(u),Cr.test(_)?u++:(_=r,v===0&&w(Nr));_!==r;)k.push(_),_=e.charAt(u),Cr.test(_)?u++:(_=r,v===0&&w(Nr));f=e.substring(f,u),l=ui(f)}else u=l,l=r;return v--,l===r&&(p=r,v===0&&w(Wn)),l}function zr(){var l,p,f,k;return v++,l=u,W(),e.charCodeAt(u)===40?(p=D,u++):(p=r,v===0&&w(Zn)),p!==r?(f=Br(),f!==r?(W(),e.charCodeAt(u)===41?(k=Pe,u++):(k=r,v===0&&w(Vn)),k!==r?l=pi(f):(u=l,l=r)):(u=l,l=r)):(u=l,l=r),v--,l===r&&v===0&&w(Qn),l}function Pi(){var l,p,f;return v++,l=u,e.substr(u,3)===Ne?(p=Ne,u+=3):(p=r,v===0&&w(Yn)),p===r&&(e.substr(u,3)===V?(p=V,u+=3):(p=r,v===0&&w(Xn)),p===r&&(e.substr(u,7)===He?(p=He,u+=7):(p=r,v===0&&w(ei)),p===r&&(e.charCodeAt(u)===42?(p=Ke,u++):(p=r,v===0&&w(ti))))),p!==r?(W(),f=Tt(),f===r&&(f=null),l=fi(p,f)):(u=l,l=r),v--,l===r&&(p=r,v===0&&w(Jn)),l}function W(){var l,p;for(v++,l=[],p=e.charAt(u),qr.test(p)?u++:(p=r,v===0&&w(Hr));p!==r;)l.push(p),p=e.charAt(u),qr.test(p)?u++:(p=r,v===0&&w(Hr));return v--,p=r,v===0&&w(ri),l}if(je=i(),t.peg$library)return{peg$result:je,peg$currPos:u,peg$FAILED:r,peg$maxFailExpected:nt,peg$maxFailPos:oe};if(je!==r&&u===e.length)return je;throw je!==r&&u<e.length&&w(hi()),gi(nt,oe<e.length?e.charAt(oe):null,oe<e.length?Or(oe,oe+1):Or(oe,oe))}var St=0xffffffffffffffffn;function fr(e,t){return(e<<t|e>>64n-t)&0xffffffffffffffffn}function dn(e,t){return e*t&St}function Ms(e){return function(){let t=BigInt(e&St),r=BigInt(e>>64n&St),o=dn(fr(dn(t,5n),7n),9n);return r^=t,t=(fr(t,24n)^r^r<<16n)&St,r=fr(r,37n),e=r<<64n|t,o}}var Ct=Ms(0xa187eb39cdcaed8f31c4b365b102e01en),Ts=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>Ct()))),$s=Array.from({length:8},()=>Ct()),Is=Array.from({length:16},()=>Ct()),hr=Ct(),F="w",Y="b",H="p",xr="n",Pt="b",tt="r",ke="q",K="k",gr="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",De=class{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,r){let{color:o,piece:n,from:i,to:s,flags:a,captured:d,promotion:c}=r,h=R(i),g=R(s);this.color=o,this.piece=n,this.from=h,this.to=g,this.san=t._moveToSan(r,t._moves({legal:!0})),this.lan=h+g,this.before=t.fen(),t._makeMove(r),this.after=t.fen(),t._undoMove(),this.flags="";for(let m in P)P[m]&a&&(this.flags+=Te[m]);d&&(this.captured=d),c&&(this.promotion=c,this.lan+=c)}isCapture(){return this.flags.indexOf(Te.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(Te.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(Te.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(Te.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(Te.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(Te.BIG_PAWN)>-1}},B=-1,Te={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"};var P={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},yr={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Ns={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Hs={...yr,...Ns},S={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},mr={b:[16,32,17,15],w:[-16,-32,-17,-15]},un={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Ks=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Os=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Rs={p:1,n:2,b:4,r:8,q:16,k:32},Ds="pnbrqkPNBRQK",pn=[xr,Pt,tt,ke],Bs=7,js=6,Fs=1,zs=0,_t={[K]:P.KSIDE_CASTLE,[ke]:P.QSIDE_CASTLE},ye={w:[{square:S.a1,flag:P.QSIDE_CASTLE},{square:S.h1,flag:P.KSIDE_CASTLE}],b:[{square:S.a8,flag:P.QSIDE_CASTLE},{square:S.h8,flag:P.KSIDE_CASTLE}]},Us={b:Fs,w:js},br="--";function $e(e){return e>>4}function rt(e){return e&15}function hn(e){return"0123456789".indexOf(e)!==-1}function R(e){let t=rt(e),r=$e(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(r,r+1)}function et(e){return e===F?Y:F}function Ws(e){let t=e.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let r=parseInt(t[5],10);if(isNaN(r)||r<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let o=parseInt(t[4],10);if(isNaN(o)||o<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let n=t[0].split("/");if(n.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let s=0;s<n.length;s++){let a=0,d=!1;for(let c=0;c<n[s].length;c++)if(hn(n[s][c])){if(d)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};a+=parseInt(n[s][c],10),d=!0}else{if(!/^[prnbqkPRNBQK]$/.test(n[s][c]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};a+=1,d=!1}if(a!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let i=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:s,regex:a}of i){if(!a.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${s} king`};if((t[0].match(a)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${s} kings`}}return Array.from(n[0]+n[7]).some(s=>s.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Gs(e,t){let r=e.from,o=e.to,n=e.piece,i=0,s=0,a=0;for(let d=0,c=t.length;d<c;d++){let h=t[d].from,g=t[d].to,m=t[d].piece;n===m&&r!==h&&o===g&&(i++,$e(r)===$e(h)&&s++,rt(r)===rt(h)&&a++)}return i>0?s>0&&a>0?R(r):a>0?R(r).charAt(1):R(r).charAt(0):""}function we(e,t,r,o,n,i=void 0,s=P.NORMAL){let a=$e(o);if(n===H&&(a===Bs||a===zs))for(let d=0;d<pn.length;d++){let c=pn[d];e.push({color:t,from:r,to:o,piece:n,captured:i,promotion:c,flags:s|P.PROMOTION})}else e.push({color:t,from:r,to:o,piece:n,captured:i,flags:s})}function fn(e){let t=e.charAt(0);return t>="a"&&t<="h"?e.match(/[a-h]\d.*[a-h]\d/)?void 0:H:(t=t.toLowerCase(),t==="o"?K:t)}function vr(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}var Et=class{_board=new Array(128);_turn=F;_header={};_kings={w:B,b:B};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=gr,{skipValidation:r=!1}={}){this.load(t,{skipValidation:r})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:B,b:B},this._turn=F,this._castling={w:0,b:0},this._epSquare=B,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...Hs},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:r=!1,preserveHeaders:o=!1}={}){let n=t.split(/\s+/);if(n.length>=2&&n.length<6){let a=["-","-","0","1"];t=n.concat(a.slice(-(6-n.length))).join(" ")}if(n=t.split(/\s+/),!r){let{ok:a,error:d}=Ws(t);if(!a)throw new Error(d)}let i=n[0],s=0;this.clear({preserveHeaders:o});for(let a=0;a<i.length;a++){let d=i.charAt(a);if(d==="/")s+=8;else if(hn(d))s+=parseInt(d,10);else{let c=d<"a"?F:Y;this._put({type:d.toLowerCase(),color:c},R(s)),s++}}this._turn=n[1],n[2].indexOf("K")>-1&&(this._castling.w|=P.KSIDE_CASTLE),n[2].indexOf("Q")>-1&&(this._castling.w|=P.QSIDE_CASTLE),n[2].indexOf("k")>-1&&(this._castling.b|=P.KSIDE_CASTLE),n[2].indexOf("q")>-1&&(this._castling.b|=P.QSIDE_CASTLE),this._epSquare=n[3]==="-"?B:S[n[3]],this._halfMoves=parseInt(n[4],10),this._moveNumber=parseInt(n[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let r=0,o="";for(let s=S.a8;s<=S.h1;s++){if(this._board[s]){r>0&&(o+=r,r=0);let{color:a,type:d}=this._board[s];o+=a===F?d.toUpperCase():d.toLowerCase()}else r++;s+1&136&&(r>0&&(o+=r),s!==S.h1&&(o+="/"),r=0,s+=8)}let n="";this._castling[F]&P.KSIDE_CASTLE&&(n+="K"),this._castling[F]&P.QSIDE_CASTLE&&(n+="Q"),this._castling[Y]&P.KSIDE_CASTLE&&(n+="k"),this._castling[Y]&P.QSIDE_CASTLE&&(n+="q"),n=n||"-";let i="-";if(this._epSquare!==B)if(t)i=R(this._epSquare);else{let s=this._epSquare+(this._turn===F?16:-16),a=[s+1,s-1];for(let d of a){if(d&136)continue;let c=this._turn;if(this._board[d]?.color===c&&this._board[d]?.type===H){this._makeMove({color:c,from:d,to:this._epSquare,piece:H,captured:H,flags:P.EP_CAPTURE});let h=!this._isKingAttacked(c);if(this._undoMove(),h){i=R(this._epSquare);break}}}}return[o,this._turn,n,i,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;let{color:r,type:o}=this._board[t],n={w:0,b:1}[r],i={p:0,n:1,b:2,r:3,q:4,k:5}[o];return Ts[n][i][t]}_epKey(){return this._epSquare===B?0n:$s[this._epSquare&7]}_castlingKey(){let t=this._castling.w>>5|this._castling.b>>3;return Is[t]}_computeHash(){let t=0n;for(let r=S.a8;r<=S.h1;r++){if(r&136){r+=7;continue}this._board[r]&&(t^=this._pieceKey(r))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=hr),t}_updateSetup(t){this._history.length>0||(t!==gr?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(gr)}get(t){return this._board[S[t]]}findPiece(t){let r=[];for(let o=S.a8;o<=S.h1;o++){if(o&136){o+=7;continue}!this._board[o]||this._board[o]?.color!==t.color||this._board[o].color===t.color&&this._board[o].type===t.type&&r.push(R(o))}return r}put({type:t,color:r},o){return this._put({type:t,color:r},o)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,r){this._hash^=this._pieceKey(t),this._board[t]=r,this._hash^=this._pieceKey(t)}_put({type:t,color:r},o){if(Ds.indexOf(t.toLowerCase())===-1||!(o in S))return!1;let n=S[o];if(t==K&&!(this._kings[r]==B||this._kings[r]==n))return!1;let i=this._board[n];return i&&i.type===K&&(this._kings[i.color]=B),this._set(n,{type:t,color:r}),t===K&&(this._kings[r]=n),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){let r=this.get(t);return this._clear(S[t]),r&&r.type===K&&(this._kings[r.color]=B),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),r}_updateCastlingRights(){this._hash^=this._castlingKey();let t=this._board[S.e1]?.type===K&&this._board[S.e1]?.color===F,r=this._board[S.e8]?.type===K&&this._board[S.e8]?.color===Y;(!t||this._board[S.a1]?.type!==tt||this._board[S.a1]?.color!==F)&&(this._castling.w&=-65),(!t||this._board[S.h1]?.type!==tt||this._board[S.h1]?.color!==F)&&(this._castling.w&=-33),(!r||this._board[S.a8]?.type!==tt||this._board[S.a8]?.color!==Y)&&(this._castling.b&=-65),(!r||this._board[S.h8]?.type!==tt||this._board[S.h8]?.color!==Y)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===B)return;let t=this._epSquare+(this._turn===F?-16:16),r=this._epSquare+(this._turn===F?16:-16),o=[r+1,r-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[r]?.color!==et(this._turn)||this._board[r]?.type!==H){this._hash^=this._epKey(),this._epSquare=B;return}let n=i=>!(i&136)&&this._board[i]?.color===this._turn&&this._board[i]?.type===H;o.some(n)||(this._hash^=this._epKey(),this._epSquare=B)}_attacked(t,r,o){let n=[];for(let i=S.a8;i<=S.h1;i++){if(i&136){i+=7;continue}if(this._board[i]===void 0||this._board[i].color!==t)continue;let s=this._board[i],a=i-r;if(a===0)continue;let d=a+119;if(Ks[d]&Rs[s.type]){if(s.type===H){if(a>0&&s.color===F||a<=0&&s.color===Y)if(o)n.push(R(i));else return!0;continue}if(s.type==="n"||s.type==="k")if(o){n.push(R(i));continue}else return!0;let c=Os[d],h=i+c,g=!1;for(;h!==r;){if(this._board[h]!=null){g=!0;break}h+=c}if(!g)if(o){n.push(R(i));continue}else return!0}}return o?n:!1}attackers(t,r){return r?this._attacked(r,S[t],!0):this._attacked(this._turn,S[t],!0)}_isKingAttacked(t){let r=this._kings[t];return r===-1?!1:this._attacked(et(t),r)}hash(){return this._hash.toString(16)}isAttacked(t,r){return this._attacked(r,S[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let t={b:0,n:0,r:0,q:0,k:0,p:0},r=[],o=0,n=0;for(let i=S.a8;i<=S.h1;i++){if(n=(n+1)%2,i&136){i+=7;continue}let s=this._board[i];s&&(t[s.type]=s.type in t?t[s.type]+1:1,s.type===Pt&&r.push(n),o++)}if(o===2)return!0;if(o===3&&(t[Pt]===1||t[xr]===1))return!0;if(o===t[Pt]+2){let i=0,s=r.length;for(let a=0;a<s;a++)i+=r[a];if(i===0||i===s)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:r=void 0,piece:o=void 0}={}){let n=this._moves({square:r,piece:o});return t?n.map(i=>new De(this,i)):n.map(i=>this._moveToSan(i,n))}_moves({legal:t=!0,piece:r=void 0,square:o=void 0}={}){let n=o?o.toLowerCase():void 0,i=r?.toLowerCase(),s=[],a=this._turn,d=et(a),c=S.a8,h=S.h1,g=!1;if(n)if(n in S)c=h=S[n],g=!0;else return[];for(let b=c;b<=h;b++){if(b&136){b+=7;continue}if(!this._board[b]||this._board[b].color===d)continue;let{type:y}=this._board[b],x;if(y===H){if(i&&i!==y)continue;x=b+mr[a][0],this._board[x]||(we(s,a,b,x,H),x=b+mr[a][1],Us[a]===$e(b)&&!this._board[x]&&we(s,a,b,x,H,void 0,P.BIG_PAWN));for(let $=2;$<4;$++)x=b+mr[a][$],!(x&136)&&(this._board[x]?.color===d?we(s,a,b,x,H,this._board[x].type,P.CAPTURE):x===this._epSquare&&we(s,a,b,x,H,H,P.EP_CAPTURE))}else{if(i&&i!==y)continue;for(let $=0,z=un[y].length;$<z;$++){let D=un[y][$];for(x=b;x+=D,!(x&136);){if(!this._board[x])we(s,a,b,x,y);else{if(this._board[x].color===a)break;we(s,a,b,x,y,this._board[x].type,P.CAPTURE);break}if(y===xr||y===K)break}}}}if((i===void 0||i===K)&&(!g||h===this._kings[a])){if(this._castling[a]&P.KSIDE_CASTLE){let b=this._kings[a],y=b+2;!this._board[b+1]&&!this._board[y]&&!this._attacked(d,this._kings[a])&&!this._attacked(d,b+1)&&!this._attacked(d,y)&&we(s,a,this._kings[a],y,K,void 0,P.KSIDE_CASTLE)}if(this._castling[a]&P.QSIDE_CASTLE){let b=this._kings[a],y=b-2;!this._board[b-1]&&!this._board[b-2]&&!this._board[b-3]&&!this._attacked(d,this._kings[a])&&!this._attacked(d,b-1)&&!this._attacked(d,y)&&we(s,a,this._kings[a],y,K,void 0,P.QSIDE_CASTLE)}}if(!t||this._kings[a]===-1)return s;let m=[];for(let b=0,y=s.length;b<y;b++)this._makeMove(s[b]),this._isKingAttacked(a)||m.push(s[b]),this._undoMove();return m}move(t,{strict:r=!1}={}){let o=null;if(typeof t=="string")o=this._moveFromSan(t,r);else if(t===null)o=this._moveFromSan(br,r);else if(typeof t=="object"){let i=this._moves();for(let s=0,a=i.length;s<a;s++)if(t.from===R(i[s].from)&&t.to===R(i[s].to)&&(!("promotion"in i[s])||t.promotion===i[s].promotion)){o=i[s];break}}if(!o)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&o.flags&P.NULL_MOVE)throw new Error("Null move not allowed when in check");let n=new De(this,o);return this._makeMove(o),this._incPositionCount(),n}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,r){this._hash^=this._pieceKey(t),this._board[r]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(r)}_makeMove(t){let r=this._turn,o=et(r);if(this._push(t),t.flags&P.NULL_MOVE){r===Y&&this._moveNumber++,this._halfMoves++,this._turn=o,this._epSquare=B;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&P.EP_CAPTURE&&(this._turn===Y?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:r})),this._board[t.to].type===K){if(this._kings[r]=t.to,t.flags&P.KSIDE_CASTLE){let n=t.to-1,i=t.to+1;this._movePiece(i,n)}else if(t.flags&P.QSIDE_CASTLE){let n=t.to+1,i=t.to-2;this._movePiece(i,n)}this._castling[r]=0}if(this._castling[r]){for(let n=0,i=ye[r].length;n<i;n++)if(t.from===ye[r][n].square&&this._castling[r]&ye[r][n].flag){this._castling[r]^=ye[r][n].flag;break}}if(this._castling[o]){for(let n=0,i=ye[o].length;n<i;n++)if(t.to===ye[o][n].square&&this._castling[o]&ye[o][n].flag){this._castling[o]^=ye[o][n].flag;break}}if(this._hash^=this._castlingKey(),t.flags&P.BIG_PAWN){let n;r===Y?n=t.to-16:n=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===H&&this._board[t.to-1]?.color===o||!(t.to+1&136)&&this._board[t.to+1]?.type===H&&this._board[t.to+1]?.color===o?(this._epSquare=n,this._hash^=this._epKey()):this._epSquare=B}else this._epSquare=B;t.piece===H?this._halfMoves=0:t.flags&(P.CAPTURE|P.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,r===Y&&this._moveNumber++,this._turn=o,this._hash^=hr}undo(){let t=this._hash,r=this._undoMove();if(r){let o=new De(this,r);return this._decPositionCount(t),o}return null}_undoMove(){let t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();let r=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=hr;let o=this._turn,n=et(o);if(r.flags&P.NULL_MOVE)return r;if(this._movePiece(r.to,r.from),r.piece&&(this._clear(r.from),this._set(r.from,{type:r.piece,color:o})),r.captured)if(r.flags&P.EP_CAPTURE){let i;o===Y?i=r.to-16:i=r.to+16,this._set(i,{type:H,color:n})}else this._set(r.to,{type:r.captured,color:n});if(r.flags&(P.KSIDE_CASTLE|P.QSIDE_CASTLE)){let i,s;r.flags&P.KSIDE_CASTLE?(i=r.to+1,s=r.to-1):(i=r.to-2,s=r.to+1),this._movePiece(s,i)}return r}pgn({newline:t=`
`,maxWidth:r=0}={}){let o=[],n=!1;for(let m in this._header)this._header[m]&&o.push(`[${m} "${this._header[m]}"]`+t),n=!0;n&&this._history.length&&o.push(t);let i=m=>{let b=this._comments[this.fen()];if(typeof b<"u"){let y=m.length>0?" ":"";m=`${m}${y}{${b}}`}return m},s=[];for(;this._history.length>0;)s.push(this._undoMove());let a=[],d="";for(s.length===0&&a.push(i(""));s.length>0;){d=i(d);let m=s.pop();if(!m)break;if(!this._history.length&&m.color==="b"){let b=`${this._moveNumber}. ...`;d=d?`${d} ${b}`:b}else m.color==="w"&&(d.length&&a.push(d),d=this._moveNumber+".");d=d+" "+this._moveToSan(m,this._moves({legal:!0})),this._makeMove(m)}if(d.length&&a.push(i(d)),a.push(this._header.Result||"*"),r===0)return o.join("")+a.join(" ");let c=function(){return o.length>0&&o[o.length-1]===" "?(o.pop(),!0):!1},h=function(m,b){for(let y of b.split(" "))if(y){if(m+y.length>r){for(;c();)m--;o.push(t),m=0}o.push(y),m+=y.length,o.push(" "),m++}return c()&&m--,m},g=0;for(let m=0;m<a.length;m++){if(g+a[m].length>r&&a[m].includes("{")){g=h(g,a[m]);continue}g+a[m].length>r&&m!==0?(o[o.length-1]===" "&&o.pop(),o.push(t),g=0):m!==0&&(o.push(" "),g++),o.push(a[m]),g+=a[m].length}return o.join("")}header(...t){for(let r=0;r<t.length;r+=2)typeof t[r]=="string"&&typeof t[r+1]=="string"&&(this._header[t[r]]=t[r+1]);return this._header}setHeader(t,r){return this._header[t]=r??yr[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=yr[t]||null,!0):!1}getHeaders(){let t={};for(let[r,o]of Object.entries(this._header))o!==null&&(t[r]=o);return t}loadPgn(t,{strict:r=!1,newlineChar:o=`\r?
`}={}){o!==`\r?
`&&(t=t.replace(new RegExp(o,"g"),`
`));let n=Ls(t);this.reset();let i=n.headers,s="";for(let c in i)c.toLowerCase()==="fen"&&(s=i[c]),this.header(c,i[c]);if(!r)s&&this.load(s,{preserveHeaders:!0});else if(i.SetUp==="1"){if(!("FEN"in i))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(i.FEN,{preserveHeaders:!0})}let a=n.root;for(;a;){if(a.move){let c=this._moveFromSan(a.move,r);if(c==null)throw new Error(`Invalid move in PGN: ${a.move}`);this._makeMove(c),this._incPositionCount()}a.comment!==void 0&&(this._comments[this.fen()]=a.comment),a=a.variations[0]}let d=n.result;d&&Object.keys(this._header).length&&this._header.Result!==d&&this.setHeader("Result",d)}_moveToSan(t,r){let o="";if(t.flags&P.KSIDE_CASTLE)o="O-O";else if(t.flags&P.QSIDE_CASTLE)o="O-O-O";else{if(t.flags&P.NULL_MOVE)return br;if(t.piece!==H){let n=Gs(t,r);o+=t.piece.toUpperCase()+n}t.flags&(P.CAPTURE|P.EP_CAPTURE)&&(t.piece===H&&(o+=R(t.from)[0]),o+="x"),o+=R(t.to),t.promotion&&(o+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?o+="#":o+="+"),this._undoMove(),o}_moveFromSan(t,r=!1){let o=vr(t);if(r||(o==="0-0"?o="O-O":o==="0-0-0"&&(o="O-O-O")),o==br)return{color:this._turn,from:0,to:0,piece:"k",flags:P.NULL_MOVE};let n=fn(o),i=this._moves({legal:!0,piece:n});for(let m=0,b=i.length;m<b;m++)if(o===vr(this._moveToSan(i[m],i)))return i[m];if(r)return null;let s,a,d,c,h,g=!1;if(a=o.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),a?(s=a[1],d=a[2],c=a[3],h=a[4],d.length==1&&(g=!0)):(a=o.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),a&&(s=a[1],d=a[2],c=a[3],h=a[4],d.length==1&&(g=!0))),n=fn(o),i=this._moves({legal:!0,piece:s||n}),!c)return null;for(let m=0,b=i.length;m<b;m++)if(d){if((!s||s.toLowerCase()==i[m].piece)&&S[d]==i[m].from&&S[c]==i[m].to&&(!h||h.toLowerCase()==i[m].promotion))return i[m];if(g){let y=R(i[m].from);if((!s||s.toLowerCase()==i[m].piece)&&S[c]==i[m].to&&(d==y[0]||d==y[1])&&(!h||h.toLowerCase()==i[m].promotion))return i[m]}}else if(o===vr(this._moveToSan(i[m],i)).replace("x",""))return i[m];return null}ascii(){let t=`   +------------------------+
`;for(let r=S.a8;r<=S.h1;r++){if(rt(r)===0&&(t+=" "+"87654321"[$e(r)]+" |"),this._board[r]){let o=this._board[r].type,i=this._board[r].color===F?o.toUpperCase():o.toLowerCase();t+=" "+i+" "}else t+=" . ";r+1&136&&(t+=`|
`,r+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){let r=this._moves({legal:!1}),o=0,n=this._turn;for(let i=0,s=r.length;i<s;i++)this._makeMove(r[i]),this._isKingAttacked(n)||(t-1>0?o+=this.perft(t-1):o++),this._undoMove();return o}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){let t=[],r=[];for(let o=S.a8;o<=S.h1;o++)this._board[o]==null?r.push(null):r.push({square:R(o),type:this._board[o].type,color:this._board[o].color}),o+1&136&&(t.push(r),r=[],o+=8);return t}squareColor(t){if(t in S){let r=S[t];return($e(r)+rt(r))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){let r=[],o=[];for(;this._history.length>0;)r.push(this._undoMove());for(;;){let n=r.pop();if(!n)break;t?o.push(new De(this,n)):o.push(this._moveToSan(n,this._moves())),this._makeMove(n)}return o}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){let r=this._positionCount.get(t)??0;r===1?this._positionCount.delete(t):this._positionCount.set(t,r-1)}_pruneComments(){let t=[],r={},o=n=>{n in this._comments&&(r[n]=this._comments[n])};for(;this._history.length>0;)t.push(this._undoMove());for(o(this.fen());;){let n=t.pop();if(!n)break;this._makeMove(n),o(this.fen())}this._comments=r}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{let r=this._comments[t];return delete this._comments[t],{fen:t,comment:r}})}setCastlingRights(t,r){for(let n of[K,ke])r[n]!==void 0&&(r[n]?this._castling[t]|=_t[n]:this._castling[t]&=~_t[n]);this._updateCastlingRights();let o=this.getCastlingRights(t);return(r[K]===void 0||r[K]===o[K])&&(r[ke]===void 0||r[ke]===o[ke])}getCastlingRights(t){return{[K]:(this._castling[t]&_t[K])!==0,[ke]:(this._castling[t]&_t[ke])!==0}}moveNumber(){return this._moveNumber}};function gn(e,t){let o=t.split(" ")[1]==="b"?"black":"white";cn(e,{fen:t,orientation:o,coordinates:!0,animation:{enabled:!1},movable:{free:!1,color:void 0},draggable:{enabled:!1},selectable:{enabled:!1},drawable:{enabled:!0,visible:!0,eraseOnClick:!1}})}function mn(e){try{return new Et(e),!0}catch{return!1}}var qt=null,_e=0,pe=new Set,kr=!1,ue=!1;function xn(e){if(!L?.cur){A("game-board");return}pe=new Set,kr=!1,ue=!1;let{catIdx:t,qIdx:r}=L.cur,o=L.pack.categories[t],n=o.questions[r],i=n.image?to(n.image):"";e.innerHTML=`
    <div class="flex flex-col items-center min-h-screen px-4 pt-6 pb-12">

      <!-- Category \xB7 Value -->
      <div class="text-center mb-3">
        <span class="text-gray-400 text-sm">${T(o.name)}</span>
        <span class="text-gray-400 text-sm"> \xB7 </span>
        <span class="text-yellow-400 font-black" style="font-size:2.5rem;vertical-align:middle">
          ${T(n.value)}
        </span>
      </div>

      <!-- Chess board -->
      ${n.fen?'<div class="cg-container mb-4" id="cg-wrap"></div>':""}

      <!-- URL image -->
      ${i?`
        <div class="mb-4">
          <img src="${i}" alt=""
               class="rounded-xl" style="max-width:min(100%,480px);max-height:320px">
        </div>`:""}

      <!-- Question text -->
      <div class="font-bold text-center mb-5"
           style="font-size:1.5rem;max-width:580px;line-height:1.3">
        ${T(n.question)}
      </div>

      <!-- Answer (hidden until revealed) -->
      <div id="answer-block"
           class="hidden text-center mb-5 px-6 py-4 rounded-xl w-full"
           style="max-width:580px;background:#1f2937">
        <div class="text-gray-400 text-sm mb-1">\u041F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u044B\u0439 \u043E\u0442\u0432\u0435\u0442:</div>
        <div class="font-semibold text-green-400" style="font-size:1.15rem">
          ${T(n.answer)}
        </div>
      </div>

      <!-- Selection hint -->
      <div id="hint" class="text-gray-500 text-xs mb-2">
        \u041D\u0430\u0436\u043C\u0438 \u043D\u0430 \u0438\u0433\u0440\u043E\u043A\u0430 \u2014 \u0435\u043C\u0443 \u043D\u0430\u0447\u0438\u0441\u043B\u044F\u0442\u0441\u044F \u043E\u0447\u043A\u0438
      </div>

      <!-- Lock indicator -->
      <div id="lock-badge" class="hidden mb-2 px-3 py-1 rounded-full text-xs font-bold"
           style="background:#374151;color:#9ca3af">
        \u{1F512} \u0417\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043E
      </div>

      <!-- Single row: players + timer + action buttons -->
      <div class="flex gap-3 justify-center items-center flex-nowrap overflow-x-auto pb-1 w-full">

        <!-- Player buttons (injected by buildPlayerButtons) -->
        <div id="player-btns" class="flex gap-3 shrink-0"></div>

        <!-- Timer (inline, hidden by default) -->
        <div id="q-timer"
             class="hidden text-yellow-400 font-black text-2xl bg-gray-800 px-5 py-3 rounded-xl min-w-[84px] text-center shrink-0">
        </div>

        <button id="btn-show-answer"
          class="text-xl px-4 py-3 rounded-xl bg-gray-700 hover:bg-gray-600 border-0 cursor-pointer text-white shrink-0"
          title="\u041F\u043E\u043A\u0430\u0437\u0430\u0442\u044C \u043E\u0442\u0432\u0435\u0442">\u{1F441}</button>

        <button id="btn-confirm"
          class="hidden text-xl px-4 py-3 rounded-xl bg-green-700 hover:bg-green-600 border-0 cursor-pointer font-bold text-white shrink-0"
          title="\u0417\u0430\u0441\u0447\u0438\u0442\u0430\u0442\u044C">\u2705</button>

        <button id="btn-skip"
          class="hidden text-xl px-4 py-3 rounded-xl bg-yellow-600 hover:bg-yellow-500 border-0 cursor-pointer text-white shrink-0"
          title="\u041F\u0440\u043E\u043F\u0443\u0441\u0442\u0438\u0442\u044C">\u23E9</button>

        <button id="btn-back"
          class="text-xl px-4 py-3 rounded-xl bg-gray-700 hover:bg-gray-600 border-0 cursor-pointer text-white shrink-0"
          title="\u041D\u0430\u0437\u0430\u0434 \u043A \u043F\u043E\u043B\u044E">\u2B05</button>
      </div>
    </div>
  `,n.fen&&gn(e.querySelector("#cg-wrap"),n.fen),Qs(e),Xs(e,n.value),ea(L.timerSecs,e);let s=a=>{(a.key==="l"||a.key==="L"||a.key==="\u0434"||a.key==="\u0414")&&ta(e)};document.addEventListener("keydown",s),e.__cleanupKey=()=>document.removeEventListener("keydown",s)}function Qs(e){let t=e.querySelector("#player-btns");L.players.forEach((r,o)=>{let n=document.createElement("button");n.className="player-btn",n.dataset.idx=String(o),n.textContent=r.name,n.addEventListener("click",()=>Zs(o,e)),t.appendChild(n)})}function Zs(e,t){ue||(pe.has(e)?pe.delete(e):pe.add(e),Vs(t),Js(t),Ys(t))}function Vs(e){e.querySelectorAll("#player-btns button").forEach(t=>{let r=Number(t.dataset.idx);pe.has(r)?(t.style.background="#059669",t.style.borderColor="#34d399",t.style.boxShadow="0 0 0 3px rgba(52,211,153,0.35)"):(t.style.background="",t.style.borderColor="",t.style.boxShadow="")})}function Js(e){let t=e.querySelector("#hint");if(pe.size===0)t.textContent="\u041D\u0430\u0436\u043C\u0438 \u043D\u0430 \u0438\u0433\u0440\u043E\u043A\u0430 \u2014 \u0435\u043C\u0443 \u043D\u0430\u0447\u0438\u0441\u043B\u044F\u0442\u0441\u044F \u043E\u0447\u043A\u0438";else{let r=[...pe].map(o=>L.players[o].name).join(", ");t.textContent=`\u041E\u0447\u043A\u0438 \u043F\u043E\u043B\u0443\u0447\u0430\u0442: ${r}`,t.style.color="#34d399"}}function Ys(e){e.querySelector("#btn-confirm").classList.toggle("hidden",pe.size===0)}function Xs(e,t){e.querySelector("#btn-show-answer").addEventListener("click",()=>{ue||yn(e)}),e.querySelector("#btn-confirm").addEventListener("click",()=>{ue||pe.size===0||(Ie(),pe.forEach(r=>{L.players[r].score+=t}),vn(),wr(e),A("game-board"))}),e.querySelector("#btn-skip").addEventListener("click",()=>{ue||(Ie(),vn(),wr(e),A("game-board"))}),e.querySelector("#btn-back").addEventListener("click",()=>{ue||(Ie(),wr(e),A("game-board"))})}function yn(e){kr=!0,e.querySelector("#answer-block").classList.remove("hidden"),e.querySelector("#btn-show-answer").classList.add("hidden"),e.querySelector("#btn-skip").classList.remove("hidden"),Ie()}function ea(e,t){if(Ie(),e<=0)return;_e=e;let r=t.querySelector("#q-timer");r.classList.remove("hidden"),r.style.color="#ffd600",r.textContent=bn(_e),qt=setInterval(()=>{_e--,r.textContent=_e>0?bn(_e):"\u23F0",_e<=5&&_e>0&&(r.style.color="#f87171"),_e<=0&&(Ie(),kr||yn(t))},1e3)}function Ie(){qt!==null&&(clearInterval(qt),qt=null)}function bn(e){let t=Math.floor(e/60),r=e%60;return t>0?`${t}:${String(r).padStart(2,"0")}`:String(e)}function ta(e){ue=!ue,e.querySelector("#lock-badge").classList.toggle("hidden",!ue),["#btn-show-answer","#btn-confirm","#btn-skip","#btn-back","#player-btns"].forEach(r=>{let o=e.querySelector(r);o&&(o.style.opacity=ue?"0.4":"1")})}function vn(){if(!L?.cur)return;let e=`${L.cur.catIdx}-${L.cur.qIdx}`;L.answered.add(e),L.cur=null,at(L);let t=L.pack.categories.reduce((r,o)=>r+o.questions.length,0);L.answered.size>=t&&A("results")}function wr(e){Ie();let t=e.__cleanupKey;t&&(t(),delete e.__cleanupKey)}function wn(e){L?.id&&st(L.id);let t=(L?.players??[]).slice().sort((o,n)=>n.score-o.score),r=t[0]?.score??0;e.innerHTML=`
    <div class="flex flex-col items-center justify-center min-h-screen p-8">
      <h2 class="font-black text-yellow-400 mb-8" style="font-size:2.5rem">\u0418\u0442\u043E\u0433\u0438 \u0438\u0433\u0440\u044B</h2>

      <div class="flex flex-col gap-3 mb-8 w-full" style="max-width:420px">
        ${t.map((o,n)=>{let i=o.score===r&&o.score>0;return`
            <div class="flex items-center gap-4 rounded-xl px-5 py-4"
                 style="background:${i?"#1e3a22":"#1f2937"};
                        ${i?"border:1px solid #16a34a":""}">
              <span style="font-size:1.8rem;min-width:2rem">${i?"\u{1F451}":n===0?"":n===1?"\u{1F948}":n===2?"\u{1F949}":""}</span>
              <span class="flex-1 font-semibold" style="font-size:1.1rem">${T(o.name)}</span>
              <span class="font-black" style="font-size:1.4rem;color:${o.score>=0?"#ffd600":"#f87171"}">
                ${o.score}
              </span>
            </div>
          `}).join("")}
      </div>

      <div class="flex gap-3 flex-wrap justify-center">
        <button id="btn-restart"
          class="px-7 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl border-0
                 text-white font-bold text-base cursor-pointer transition-colors">
          \u0421\u044B\u0433\u0440\u0430\u0442\u044C \u0441\u043D\u043E\u0432\u0430
        </button>
        <button id="btn-home"
          class="px-7 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl border-0
                 text-white font-bold text-base cursor-pointer transition-colors">
          \u041D\u0430 \u0433\u043B\u0430\u0432\u043D\u0443\u044E
        </button>
      </div>
    </div>
  `,e.querySelector("#btn-restart").addEventListener("click",()=>A("setup")),e.querySelector("#btn-home").addEventListener("click",()=>A("home"))}var M=kn(),re=-1;function kn(){return{title:"",categories:[{name:"",questions:[{value:100,question:"",answer:""}]}]}}function _n(e){Lt(e)}function Lt(e){let t=ne();e.innerHTML=`
    <div class="min-h-screen p-6" style="max-width:820px;margin:0 auto">

      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">\u0420\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u0432\u043E\u043F\u0440\u043E\u0441\u043E\u0432</h2>
        <button id="btn-back"
          class="text-blue-400 hover:text-blue-300 bg-transparent border-0 cursor-pointer">
          \u2190 \u041D\u0430\u0437\u0430\u0434
        </button>
      </div>

      <div class="flex gap-3 mb-6 flex-wrap">
        <button id="btn-new-pack"
          class="px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-xl border-0 text-white
                 font-bold text-sm cursor-pointer transition-colors">
          + \u041D\u043E\u0432\u044B\u0439 \u043D\u0430\u0431\u043E\u0440
        </button>
        <button id="btn-import-list"
          class="px-4 py-2.5 bg-gray-700 hover:bg-gray-600 rounded-xl border-0 text-white
                 text-sm cursor-pointer transition-colors">
          \u0418\u043C\u043F\u043E\u0440\u0442 JSON
        </button>
        <input type="file" id="file-input-list" accept=".json" class="hidden" />
      </div>

      <div id="pack-list" class="space-y-2">
        ${t.length===0?`<p class="text-gray-500 text-center py-8">
               \u041D\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D\u043D\u044B\u0445 \u043D\u0430\u0431\u043E\u0440\u043E\u0432. \u0421\u043E\u0437\u0434\u0430\u0439\u0442\u0435 \u043D\u043E\u0432\u044B\u0439 \u0438\u043B\u0438 \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u0443\u0439\u0442\u0435 JSON.
             </p>`:t.map((r,o)=>`
              <div class="bg-gray-800 rounded-xl p-4 flex items-center justify-between gap-4">
                <div class="min-w-0">
                  <div class="font-bold text-base truncate">${T(r.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</div>
                  <div class="text-gray-400 text-sm">
                    ${r.categories.length} \u043A\u0430\u0442. /
                    ${r.categories.reduce((n,i)=>n+i.questions.length,0)} \u0432\u043E\u043F\u0440.
                  </div>
                </div>
                <div class="flex gap-2 shrink-0">
                  <button data-edit="${o}"
                    class="bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded-lg text-sm
                           border-0 cursor-pointer text-white transition-colors">\u0420\u0435\u0434.</button>
                  <button data-export="${o}"
                    class="bg-gray-600 hover:bg-gray-500 px-3 py-2 rounded-lg text-sm
                           border-0 cursor-pointer text-white transition-colors">JSON</button>
                  <button data-del="${o}"
                    class="bg-red-700/80 hover:bg-red-600 px-3 py-2 rounded-lg text-sm
                           border-0 cursor-pointer text-white transition-colors">\u0423\u0434.</button>
                </div>
              </div>
            `).join("")}
      </div>
    </div>
  `,e.querySelector("#btn-back").addEventListener("click",()=>A("home")),e.querySelector("#btn-new-pack").addEventListener("click",()=>{M=kn(),re=-1,_r(e)}),e.querySelector("#btn-import-list").addEventListener("click",()=>{e.querySelector("#file-input-list").click()}),e.querySelector("#file-input-list").addEventListener("change",r=>{let o=r.target.files?.[0];if(!o)return;let n=new FileReader;n.onload=()=>{try{let i=JSON.parse(n.result);if(!i.title||!Array.isArray(i.categories))throw new Error("\u041D\u0435\u0442 \u043F\u043E\u043B\u0435\u0439 title/categories");M=i,re=-1,_r(e)}catch(i){We(`\u041E\u0448\u0438\u0431\u043A\u0430 JSON: ${i.message}`)}},n.readAsText(o),r.target.value=""}),e.querySelectorAll("[data-edit]").forEach(r=>{r.addEventListener("click",()=>{let o=+r.dataset.edit;M=JSON.parse(JSON.stringify(ne()[o])),re=o,_r(e)})}),e.querySelectorAll("[data-export]").forEach(r=>{r.addEventListener("click",()=>{let o=ne()[+r.dataset.export];Sn(o)})}),e.querySelectorAll("[data-del]").forEach(r=>{r.addEventListener("click",()=>{be("\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043D\u0430\u0431\u043E\u0440?",()=>{Zr(+r.dataset.del),Lt(e)},{confirmLabel:"\u0423\u0434\u0430\u043B\u0438\u0442\u044C"})})})}function _r(e){e.innerHTML=`
    <div class="min-h-screen p-6" style="max-width:820px;margin:0 auto">

      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">
          ${re>=0?"\u0420\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u043D\u0430\u0431\u043E\u0440\u0430":"\u041D\u043E\u0432\u044B\u0439 \u043D\u0430\u0431\u043E\u0440"}
        </h2>
        <button id="btn-to-list"
          class="text-blue-400 hover:text-blue-300 bg-transparent border-0 cursor-pointer">
          \u2190 \u041A \u0441\u043F\u0438\u0441\u043A\u0443
        </button>
      </div>

      <!-- Pack title -->
      <div class="mb-4">
        <label class="block text-sm text-gray-400 mb-1">\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u043D\u0430\u0431\u043E\u0440\u0430</label>
        <input id="pack-title" type="text" value="${T(M.title)}"
          class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white
                 focus:border-blue-500 focus:outline-none"
          placeholder="\u041D\u0430\u043F\u0440\u0438\u043C\u0435\u0440: \u0428\u0430\u0445\u043C\u0430\u0442\u043D\u044B\u0435 \u0437\u0430\u0434\u0430\u0447\u0438" />
      </div>

      <!-- Categories -->
      <div id="categories-container" class="space-y-4 mb-4"></div>

      <!-- Add category -->
      <button id="btn-add-cat"
        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg border-0 text-white
               text-sm cursor-pointer mb-6 transition-colors">
        + \u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F
      </button>

      <!-- Bottom actions -->
      <div class="flex gap-3 pt-4 border-t border-gray-800 flex-wrap">
        <button id="btn-save"
          class="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl border-0 text-white
                 font-bold cursor-pointer transition-colors">
          \u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C
        </button>
        <button id="btn-play"
          class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl border-0 text-white
                 font-bold cursor-pointer transition-colors">
          \u25B6 \u0418\u0433\u0440\u0430\u0442\u044C
        </button>
        <button id="btn-export-pack"
          class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl border-0 text-white
                 font-bold cursor-pointer transition-colors">
          \u0421\u043A\u0430\u0447\u0430\u0442\u044C JSON
        </button>
        <button id="btn-cancel"
          class="px-6 py-3 bg-gray-800 hover:bg-gray-700 rounded-xl border-0 text-white
                 cursor-pointer transition-colors">
          \u041E\u0442\u043C\u0435\u043D\u0430
        </button>
      </div>

      <div id="status" class="mt-3 text-sm"></div>
    </div>
  `,Se(e),e.querySelector("#pack-title").addEventListener("input",t=>{M.title=t.target.value}),e.querySelector("#btn-to-list").addEventListener("click",()=>Lt(e)),e.querySelector("#btn-add-cat").addEventListener("click",()=>{M.categories.push({name:"",questions:[{value:100,question:"",answer:""}]}),Se(e)}),e.querySelector("#btn-save").addEventListener("click",()=>{let t=Sr(M);if(t){At(e,`\u2717 ${t}`,!1);return}Ht(M,re>=0?re:void 0),re<0&&(re=ne().length-1),At(e,"\u2713 \u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E",!0)}),e.querySelector("#btn-play").addEventListener("click",()=>{let t=Sr(M);if(t){At(e,`\u2717 ${t}`,!1);return}Ht(M,re>=0?re:void 0);let r=ne(),o=re>=0?re:r.length-1;Ue(Vr+o),A("setup")}),e.querySelector("#btn-export-pack").addEventListener("click",()=>{let t=Sr(M);if(t){At(e,`\u2717 ${t}`,!1);return}Sn(M)}),e.querySelector("#btn-cancel").addEventListener("click",()=>Lt(e))}function Se(e){let t=e.querySelector("#categories-container");t.innerHTML=M.categories.map((r,o)=>ra(r,o)).join(""),na(e)}function ra(e,t){return`
    <div class="rounded-xl p-4 space-y-3"
         style="background:rgba(31,41,55,0.5);border:1px solid rgba(55,65,81,0.5)">

      <div class="flex items-center gap-3">
        <input data-cat-name="${t}" type="text" value="${T(e.name)}"
          class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white font-bold
                 focus:border-blue-500 focus:outline-none"
          placeholder="\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438" />
        <button data-remove-cat="${t}"
          class="text-red-400 hover:text-red-300 bg-transparent border-0 cursor-pointer
                 text-sm transition-colors whitespace-nowrap">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>
      </div>

      <div data-questions="${t}" class="space-y-2">
        ${e.questions.map((r,o)=>oa(e,r,t,o)).join("")}
      </div>

      <button data-add-q="${t}"
        class="text-sm text-blue-400 hover:text-blue-300 bg-transparent border-0
               cursor-pointer transition-colors">+ \u0412\u043E\u043F\u0440\u043E\u0441</button>
    </div>
  `}function oa(e,t,r,o){return`
    <div class="rounded-lg p-3 space-y-2" style="background:rgba(17,24,39,0.6)">
      <div class="flex gap-2 items-center">
        <div class="flex flex-col gap-0.5 shrink-0">
          <button data-move-up="${r}-${o}" ${o===0?"disabled":""}
            class="text-gray-400 hover:text-white text-xs leading-none px-1
                   disabled:opacity-20 cursor-pointer bg-transparent border-0 transition-colors">\u25B2</button>
          <button data-move-down="${r}-${o}" ${o===e.questions.length-1?"disabled":""}
            class="text-gray-400 hover:text-white text-xs leading-none px-1
                   disabled:opacity-20 cursor-pointer bg-transparent border-0 transition-colors">\u25BC</button>
        </div>
        <input data-q-value="${r}-${o}" type="number" value="${t.value}" step="100" min="0"
          class="w-24 bg-gray-800 border border-gray-700 rounded px-2 py-1.5 text-yellow-400
                 text-center font-bold focus:border-blue-500 focus:outline-none" />
        <input data-q-question="${r}-${o}" type="text" value="${T(t.question)}"
          class="flex-1 bg-gray-800 border border-gray-700 rounded px-2 py-1.5 text-white
                 focus:border-blue-500 focus:outline-none"
          placeholder="\u0412\u043E\u043F\u0440\u043E\u0441" />
        <button data-duplicate-q="${r}-${o}"
          class="text-blue-400 hover:text-blue-300 bg-transparent border-0 cursor-pointer
                 text-xs shrink-0 transition-colors" title="\u0414\u0443\u0431\u043B\u0438\u0440\u043E\u0432\u0430\u0442\u044C">\u29C9</button>
        <button data-remove-q="${r}-${o}"
          class="text-red-400 hover:text-red-300 bg-transparent border-0 cursor-pointer
                 text-xs shrink-0 transition-colors">\u2715</button>
      </div>
      <input data-q-answer="${r}-${o}" type="text" value="${T(t.answer)}"
        class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1.5 text-emerald-400
               focus:border-blue-500 focus:outline-none"
        placeholder="\u041E\u0442\u0432\u0435\u0442" />
      <input data-q-image="${r}-${o}" type="text" value="${T(t.image??"")}"
        class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1.5 text-blue-400 text-sm
               focus:border-blue-500 focus:outline-none"
        placeholder="URL \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0438 (https://...)" />
      <input data-q-fen="${r}-${o}" type="text" value="${T(t.fen??"")}"
        class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1.5 text-purple-400
               text-sm font-mono focus:border-blue-500 focus:outline-none"
        placeholder="FEN \u043F\u043E\u0437\u0438\u0446\u0438\u0438 (\u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E)" />
    </div>
  `}function na(e){let t=e.querySelector("#categories-container");t.querySelectorAll("[data-cat-name]").forEach(r=>{r.addEventListener("input",()=>{M.categories[+r.dataset.catName].name=r.value})}),t.querySelectorAll("[data-remove-cat]").forEach(r=>{r.addEventListener("click",()=>{be("\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044E?",()=>{M.categories.splice(+r.dataset.removeCat,1),Se(e)},{confirmLabel:"\u0423\u0434\u0430\u043B\u0438\u0442\u044C"})})}),t.querySelectorAll("[data-q-value]").forEach(r=>{r.addEventListener("input",()=>{let[o,n]=r.dataset.qValue.split("-").map(Number);M.categories[o].questions[n].value=Number(r.value)||0})}),t.querySelectorAll("[data-q-question]").forEach(r=>{r.addEventListener("input",()=>{let[o,n]=r.dataset.qQuestion.split("-").map(Number);M.categories[o].questions[n].question=r.value})}),t.querySelectorAll("[data-q-answer]").forEach(r=>{r.addEventListener("input",()=>{let[o,n]=r.dataset.qAnswer.split("-").map(Number);M.categories[o].questions[n].answer=r.value})}),t.querySelectorAll("[data-q-image]").forEach(r=>{r.addEventListener("input",()=>{let[o,n]=r.dataset.qImage.split("-").map(Number);M.categories[o].questions[n].image=r.value.trim()||void 0})}),t.querySelectorAll("[data-q-fen]").forEach(r=>{r.addEventListener("input",()=>{let[o,n]=r.dataset.qFen.split("-").map(Number);M.categories[o].questions[n].fen=r.value.trim()||void 0})}),t.querySelectorAll("[data-move-up]").forEach(r=>{r.addEventListener("click",()=>{let[o,n]=r.dataset.moveUp.split("-").map(Number);if(n===0)return;let i=M.categories[o].questions;[i[n-1],i[n]]=[i[n],i[n-1]],Se(e)})}),t.querySelectorAll("[data-move-down]").forEach(r=>{r.addEventListener("click",()=>{let[o,n]=r.dataset.moveDown.split("-").map(Number),i=M.categories[o].questions;n>=i.length-1||([i[n],i[n+1]]=[i[n+1],i[n]],Se(e))})}),t.querySelectorAll("[data-duplicate-q]").forEach(r=>{r.addEventListener("click",()=>{let[o,n]=r.dataset.duplicateQ.split("-").map(Number),i=M.categories[o].questions;i.splice(n+1,0,JSON.parse(JSON.stringify(i[n]))),Se(e)})}),t.querySelectorAll("[data-remove-q]").forEach(r=>{r.addEventListener("click",()=>{let[o,n]=r.dataset.removeQ.split("-").map(Number),i=M.categories[o].questions,s=()=>{i.splice(n,1),Se(e)};i.length<=1?be("\u041F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0439 \u0432\u043E\u043F\u0440\u043E\u0441. \u0423\u0434\u0430\u043B\u0438\u0442\u044C?",s,{confirmLabel:"\u0423\u0434\u0430\u043B\u0438\u0442\u044C"}):s()})}),t.querySelectorAll("[data-add-q]").forEach(r=>{r.addEventListener("click",()=>{let o=+r.dataset.addQ,n=M.categories[o].questions,i=n.at(-1)?.value??0;n.push({value:i+100,question:"",answer:""}),Se(e)})})}function Sr(e){if(!e.title.trim())return"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u043D\u0430\u0431\u043E\u0440\u0430";if(!e.categories.length)return"\u0414\u043E\u0431\u0430\u0432\u044C\u0442\u0435 \u0445\u043E\u0442\u044F \u0431\u044B \u043E\u0434\u043D\u0443 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044E";for(let[t,r]of e.categories.entries()){if(!r.name.trim())return`\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F ${t+1}: \u0432\u0432\u0435\u0434\u0438\u0442\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435`;if(!r.questions.length)return`"${r.name}": \u0434\u043E\u0431\u0430\u0432\u044C\u0442\u0435 \u0445\u043E\u0442\u044F \u0431\u044B \u043E\u0434\u0438\u043D \u0432\u043E\u043F\u0440\u043E\u0441`;for(let[o,n]of r.questions.entries()){if(!n.question.trim())return`"${r.name}"[${o+1}]: \u043D\u0435\u0442 \u0442\u0435\u043A\u0441\u0442\u0430 \u0432\u043E\u043F\u0440\u043E\u0441\u0430`;if(!n.answer.trim())return`"${r.name}"[${o+1}]: \u043D\u0435\u0442 \u043E\u0442\u0432\u0435\u0442\u0430`;if(n.fen&&!mn(n.fen))return`"${r.name}"[${o+1}]: \u043D\u0435\u0432\u0430\u043B\u0438\u0434\u043D\u044B\u0439 FEN`}}return null}function At(e,t,r){let o=e.querySelector("#status");o.textContent=t,o.style.color=r?"#4ade80":"#f87171"}function Sn(e){let t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),r=document.createElement("a");r.href=URL.createObjectURL(t),r.download=`${e.title||"pack"}.json`,r.click()}var Pn=document.getElementById("app");if(!Pn)throw new Error("#app element not found");var ia={home:Dt,setup:jt,"game-board":no,question:xn,results:wn,editor:_n};Wr(Pn,ia);A("home");})();
/*! Bundled license information:

chess.js/dist/esm/chess.js:
  (**
   * @license
   * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
   * All rights reserved.
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are met:
   *
   * 1. Redistributions of source code must retain the above copyright notice,
   *    this list of conditions and the following disclaimer.
   * 2. Redistributions in binary form must reproduce the above copyright notice,
   *    this list of conditions and the following disclaimer in the documentation
   *    and/or other materials provided with the distribution.
   *
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
   * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
   * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
   * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
   * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
   * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
   * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
   * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
   * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
   * POSSIBILITY OF SUCH DAMAGE.
   *)
*/
//# sourceMappingURL=bundle.js.map
